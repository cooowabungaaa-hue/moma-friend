<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚‚ã¾ã¡ã‚ƒã‚“ã®ãŠéƒ¨å±‹ - Moma's Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
        }

        #room-container {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background-image: url('./room-bg-v2.png');
            background-size: cover;
            background-position: center bottom;
            position: relative;
            background-repeat: no-repeat;
            background-color: #fdf6ec;
        }

        /* No need for separate mobile sizing with the new dynamic calculation */
        @media (max-width: 768px) {
            #room-container {
                background-size: cover;
                background-position: center bottom;
            }
        }

        /* Add a subtle overlay to make it look intentionally stylistic and hide bottom edge */
        #room-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.4), transparent);
            pointer-events: none;
            z-index: 1;
        }

        /* Moma-chan Character */
        #moma-character {
            position: absolute;
            width: 250px;
            height: auto;
            transition: top 2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                left 2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.15));
            z-index: 10;
        }

        @media (max-width: 768px) {
            #moma-character {
                width: 160px;
            }
        }

        #moma-character:active {
            transition: none;
            /* Instant feedback on click/pet */
        }

        /* Breathing Animation */
        .breathe {
            animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        /* Walking Animation (bobbing) - made slightly snappier */
        .walk {
            animation: walk 0.4s ease-in-out infinite;
        }

        @keyframes walk {

            0%,
            100% {
                transform: translateY(0) rotate(-2deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

        /* Heart Bubble */
        .heart-bubble {
            position: absolute;
            font-size: 2rem;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0;
            }

            20% {
                transform: translateY(-10px) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        /* UI Controls */
        .ui-panel {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.4);
            /* More transparent to show floor */
            backdrop-filter: blur(8px);
            padding: 0.8rem 1.5rem;
            border-radius: 9999px;
            display: flex;
            gap: 1.2rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
            /* Subtle shadow */
            z-index: 30;
            width: max-content;
            max-width: 95vw;
        }

        @media (max-width: 640px) {
            .ui-panel {
                /* Use dynamic viewport safe area if available, otherwise lift it higher */
                bottom: calc(0.6rem + env(safe-area-inset-bottom, 0px));
                padding: 0.4rem 0.5rem;
                gap: 0.3rem;
                border-radius: 1.2rem;
                justify-content: center;
                flex-wrap: nowrap !important;
                width: auto;
                max-width: 98vw;
                background: rgba(255, 255, 255, 0.8);
            }

            button.action-btn {
                width: 2.2rem;
                height: 2.2rem;
                font-size: 0.9rem;
            }

            .settings-btn {
                width: 1.6rem;
                height: 1.6rem;
            }
        }

        button.action-btn {
            font-size: 1.5rem;
            padding: 0.5rem;
            border-radius: 50%;
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #E0BBE4;
            transition: all 0.2s;
        }

        button.action-btn:hover {
            transform: scale(1.1);
            background: #FEC8D8;
        }

        /* Settings Button - simplified */
        .settings-btn {
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fdfdfd;
            border: 2px solid #FFDEE9;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .settings-btn:hover {
            background: #f0f0f0;
            transform: rotate(30deg);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #FFB6C1;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #FFDEE9;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-align: center;
            outline: none;
        }

        .modal-btn-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 8px 20px;
            border-radius: 999px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-confirm {
            background: #FFB6C1;
            color: white;
        }

        .btn-cancel {
            background: #eee;
            color: #666;
        }

        .btn-rethink {
            background: #E0BBE4;
            color: white;
        }

        .btn-reset {
            background: #ffaaaa;
            color: white;
            font-size: 0.8rem;
            margin-top: 1rem;
        }

        .modal-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .moma-suggestion-img {
            width: 100px;
            margin: 0 auto 1rem;
        }

        /* Amoeba Topic Menu */
        #topic-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            background: rgba(255, 240, 245, 0.95);
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(8px);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .topic-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            margin-bottom: 40px;
        }

        .amoeba-btn {
            background: white;
            border: 3px solid #FFDEE9;
            padding: 20px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff69b4;
            cursor: pointer;
            transition: all 0.5s ease;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;

            /* Amoeba Shape */
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation: morph 8s ease-in-out infinite, float 4s ease-in-out infinite;
        }

        .amoeba-btn:nth-child(even) {
            border-radius: 30% 70% 70% 30% / 50% 60% 40% 50%;
            animation-delay: -2s;
        }

        .amoeba-btn:hover {
            transform: scale(1.1);
            background: #FFE4E1;
            border-color: #FFB6C1;
        }

        @media (max-width: 640px) {
            .topic-container {
                gap: 12px;
                margin-bottom: 20px;
            }

            .amoeba-btn {
                padding: 12px 18px;
                font-size: 0.9rem;
                border-width: 2px;
            }

            #moma-look-up {
                width: 120px;
            }
        }

        @keyframes morph {
            0% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }

            50% {
                border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
            }

            100% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        #moma-look-up {
            width: 200px;
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {

            0%,
            100% {
                transform: rotate(-5deg);
            }

            50% {
                transform: rotate(5deg);
            }
        }

        /* Speech Bubble */
        .speech-bubble {
            position: absolute;
            background: white;
            border-radius: 20px;
            padding: 15px 25px;
            color: #333;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            z-index: 50;
            display: none;
            max-width: 320px;
            text-align: center;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: white transparent transparent;
        }

        .speech-bubble.bubble-below::after {
            bottom: auto;
            top: -15px;
            border-width: 0 15px 15px;
            border-color: transparent transparent white;
        }

        /* Chat Input Container */
        .chat-input-container {
            margin-top: 20px;
            display: none;
            /* Hidden until topic selected */
            gap: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 999px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            align-items: center;
            box-sizing: border-box;
        }

        @media (max-width: 640px) {
            .chat-input-container {
                padding: 6px 10px;
                gap: 8px;
            }
        }

        .back-btn {
            background: #eee;
            border: none;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        #user-input {
            border: none;
            outline: none;
            flex-grow: 1;
            font-size: 1rem;
            color: #333;
            min-width: 0;
            background: transparent;
        }

        .send-btn {
            background: #FFB6C1;
            color: white;
            border: none;
            width: 54px;
            height: 54px;
            min-width: 54px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        @media (max-width: 640px) {
            .send-btn {
                width: 44px;
                height: 44px;
                min-width: 44px;
                font-size: 0.75rem;
            }
        }

        .send-btn:hover {
            background: #FF69B4;
            transform: scale(1.05);
        }

        /* Night Sky Effect */
        #night-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0d1b2a 0%, #1b263b 100%);
            opacity: 0;
            transition: opacity 2s ease-in-out;
            pointer-events: none;
            z-index: 5;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle var(--duration) infinite ease-in-out var(--delay);
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0;
                transform: scale(0.5);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        /* Sub Menu Styling (Food Menu) */
        .sub-menu {
            position: absolute;
            bottom: 7rem;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            padding: 0.8rem;
            border-radius: 20px;
            display: none;
            gap: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            z-index: 40;
            border: 2px solid #FFDEE9;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }

        .sub-menu.active {
            display: flex;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .sub-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 5px;
            border-radius: 12px;
        }

        .sub-btn:hover {
            transform: scale(1.1);
            background: #fff0f5;
        }

        .sub-btn span {
            font-size: 1.5rem;
        }

        .sub-btn label {
            font-size: 0.6rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
        }

        /* Continuous Walk Indicator */
        .walking-mode .action-btn[onclick="toggleWalkMode()"] {
            background: #FFB6C1;
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.6);
            border-color: #FF69B4;
        }

        /* Transition Overlay */
        #transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s ease-in-out;
        }
    </style>
</head>

<body>

    <div id="room-container">
        <!-- Transition Overlay -->
        <div id="transition-overlay"></div>

        <!-- Night Overlay -->
        <div id="night-overlay"></div>

        <!-- Moma-chan -->
        <div id="moma-character" class="breathe" onclick="petMoma()">
            <img id="moma-img" src="./moma-idle.png" alt="Moma-chan" style="width: 100%; pointer-events: none;">
        </div>

        <!-- Food Sub Menu -->
        <div id="food-menu" class="sub-menu">
            <div class="sub-btn" onclick="feedMoma('meal')">
                <span>ğŸš</span>
                <label>ã”ã¯ã‚“</label>
            </div>
            <div class="sub-btn" onclick="feedMoma('sweets')">
                <span>ğŸ°</span>
                <label>ãŠã‚„ã¤</label>
            </div>
            <div class="sub-btn" onclick="feedMoma('drink')">
                <span>ğŸ¥¤</span>
                <label>ã®ã¿ã‚‚ã®</label>
            </div>
        </div>

        <!-- Sleep Sub Menu -->
        <div id="sleep-menu" class="sub-menu">
            <div class="sub-btn" onclick="selectSleepSong(1)">
                <span>ğŸ</span>
                <label>ã‹ãœ</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(2)">
                <span>ğŸš</span>
                <label>ãªã¿</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(3)">
                <span>ğŸ•¯ï¸</span>
                <label>ã¨ã‚‚ã—ã³</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(4)">
                <span>ğŸ§¸</span>
                <label>ã¾ã©ã‚ã¿</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(5)">
                <span>â˜ï¸</span>
                <label>ãã‚‚</label>
            </div>
        </div>

        <!-- UI Controls (Tamagotchi Style) -->
        <div class="ui-panel">
            <button class="action-btn" onclick="toggleFoodMenu()" title="ãªã«ã‹ãŸã¹ã‚‹ï¼Ÿ">ğŸ¥ª</button>
            <button class="action-btn" onclick="toggleWalkMode()" title="ãŠã•ã‚“ã½ãƒ¢ãƒ¼ãƒ‰">ğŸ¾</button>
            <button class="action-btn" onclick="openChat()" title="ãŠã¯ãªã—">ğŸ’¬</button>
            <button class="action-btn" onclick="toggleSleepMenu()" title="å¤¢ã®ä¸­ã¸">ğŸŒ™</button>
            <button class="action-btn bg-slate-100" onclick="navigateWithTransition('index.html')"
                title="ã‚‚ã©ã‚‹">ğŸ </button>
            <button class="settings-btn" title="ãŠãªã¾ãˆ" onclick="openSettings()">ğŸ“›</button>
        </div>

        <!-- Topic Menu -->
        <div id="topic-menu" onclick="closeChat(event)">
            <div class="topic-container" id="menu-topics" onclick="event.stopPropagation()">
                <button class="amoeba-btn" onclick="selectTopic('ãŠã‚„ã¤')">ãŠã‚„ã¤ğŸ­</button>
                <button class="amoeba-btn" onclick="selectTopic('ãŠã„ã—ã„ã‚‚ã®')">ãŠã„ã—ã„ã‚‚ã®ğŸ˜‹</button>
                <button class="amoeba-btn" onclick="selectTopic('ã“ã‚Œã™ã')">ã“ã‚Œã™ãâ¤ï¸</button>
                <button class="amoeba-btn" onclick="selectTopic('ã¤ã¾ã‚“ãªã„')">ã¤ã¾ã‚“ãªã„ğŸ’¤</button>
                <button class="amoeba-btn" onclick="selectTopic('ãŸã®ã—ï½')">ãŸã®ã—ã€œâœ¨</button>
                <button class="amoeba-btn" onclick="selectTopic('ã“ã‚ã„')">ã“ã‚ã„ğŸ’§</button>
                <button class="amoeba-btn" onclick="selectTopic('ãã„ã¦ï¼')">ãã„ã¦ï¼ğŸ“¢</button>
                <button class="amoeba-btn" onclick="selectTopic('ãŠã•ã‚“ã½')">ãŠã•ã‚“ã½ğŸ¾</button>
                <button class="amoeba-btn" onclick="selectTopic('ã ã„ã™ã')">ã ã„ã™ãğŸ’•</button>
                <button class="amoeba-btn" onclick="selectTopic('ãªã„ã—ã‚‡è©±')">ãªã„ã—ã‚‡è©±ğŸ¤«</button>
                <button class="amoeba-btn" onclick="selectTopic('ãŠãªã‹ã¸ã£ãŸ')">ãŠãªã‹ã¸ã£ãŸğŸš</button>
                <button class="amoeba-btn" onclick="selectTopic('ãªã«é£Ÿã¹ã‚ˆã£ã‹ï½', true)">ãªã«é£Ÿã¹ã‚ˆã£ã‹ï½ğŸ´</button>
                <button class="amoeba-btn" onclick="selectTopic('ã“ã‚ã„ã¯ãªã—ã—ã¦', true)">ã“ã‚ã„ã¯ãªã—ã—ã¦ğŸ‘»</button>
                <button class="amoeba-btn" onclick="selectTopic('å¤¢å ã„ã—ã¦ğŸŒ™', true)">å¤¢å ã„ã—ã¦ğŸŒ™</button>
            </div>

            <div class="chat-input-container" id="menu-input" onclick="event.stopPropagation()">
                <button class="back-btn" onclick="showTopics()">â†</button>
                <input type="text" id="user-input" placeholder="ã‚‚ã¾ã¡ã‚ƒã‚“ã«ãªã«ã‹è©±ã—ã¦..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendChat()">é€ä¿¡</button>
            </div>

            <p id="menu-instruction" class="mt-4 text-pink-400 font-bold">ã©ã®ãŠã¯ãªã—ã«ã™ã‚‹ï¼Ÿ</p>
            <img src="./moma-idle.png" id="moma-look-up" alt="looking up moma">
        </div>

        <!-- Name Registration Modal -->
        <div id="name-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">ãŠãªã¾ãˆã‚’ãŠã—ãˆã¦ï¼</div>
                <p class="text-xs text-gray-400 mb-4">ã²ã‚‰ãŒãªã§ã„ã‚Œã¦ã­âœ¨</p>
                <input type="text" id="base-name-input" class="modal-input" placeholder="ãªã¾ãˆï¼ˆã²ã‚‰ãŒãªï¼‰" maxlength="10">
                <div class="modal-btn-container">
                    <button class="modal-btn btn-cancel" onclick="closeModal('name-modal')">ã‚„ã‚ã¨ã</button>
                    <button class="modal-btn btn-confirm" onclick="requestNickname()">ãŠã—ãˆã‚‹ï¼</button>
                </div>
            </div>
        </div>

        <!-- Nickname Suggestion Modal -->
        <div id="suggestion-modal" class="modal-overlay">
            <div class="modal-content">
                <img src="./moma-idle.png" class="moma-suggestion-img" alt="thinking moma">
                <div id="suggestion-text" class="modal-title">ã€Œâ—‹â—‹ã‚Šã‚“ã€ã¯ã©ã†ã‚‚ã¾ï¼Ÿ</div>
                <div class="modal-btn-container">
                    <button class="modal-btn btn-confirm" onclick="saveNickname()">ã„ã„ã­ï¼âœ¨</button>
                    <button class="modal-btn btn-rethink" onclick="requestNickname()">ã¡ãŒã†ã®ï¼</button>
                    <button class="modal-btn btn-cancel" onclick="closeModal('suggestion-modal')">ã‚„ã°ã‚Šã„ã„ã‚„</button>
                </div>
            </div>
        </div>

        <!-- Settings/Reset Modal -->
        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">ã›ã£ã¦ã„</div>
                <div id="current-name-display" class="mb-4 text-gray-600"></div>
                <button id="reset-name-btn" class="modal-btn btn-reset" onclick="resetNickname()"
                    style="display:none;">ãŠãªã¾ãˆã®ç™»éŒ²ã‚’ã‘ã™</button>
                <div class="mt-4">
                    <button class="modal-btn btn-cancel" onclick="closeModal('settings-modal')">ã¨ã˜ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- Response Bubble -->
        <div id="moma-bubble" class="speech-bubble"></div>
    </div>

    <script>
        const MOMA_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzI3aafv2e1g9Zqpx3FntaYVSua-LulJIPolrEz_QwfS8w8TjmDp2PNfuU-oqX71yGhYzIqGpQcbV8/pub?gid=0&single=true&output=csv";

        const moma = document.getElementById('moma-character');
        const momaImg = document.getElementById('moma-img');
        const container = document.getElementById('room-container');

        let state = 'IDLE'; // IDLE, WALKING, EATING, SLEEPING
        let width = container.offsetWidth;
        let height = container.offsetHeight;
        let momaX = width / 2 - 125;
        let momaY = height / 2 + 100;

        // Initialize Position
        updatePosition();
        setState('IDLE', false); // Ensure initial state is set correctly with image

        async function loadMomaData() {
            if (!MOMA_SHEET_URL) return;
            try {
                const response = await fetch(MOMA_SHEET_URL);
                const csvText = await response.text();
                const rows = [];
                const lines = csvText.split(/\r?\n/);
                for (let line of lines) {
                    if (!line.trim()) continue;
                    const row = [];
                    let cur = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                cur += '"'; i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            row.push(cur.trim());
                            cur = '';
                        } else {
                            cur += char;
                        }
                    }
                    row.push(cur.trim());
                    rows.push(row);
                }

                const newMeals = [];
                const newStories = [];
                const newContexts = {};
                const newDreamDictionary = {};

                for (let i = 1; i < rows.length; i++) {
                    const [type, topic, text, weightStr] = rows[i];
                    if (!text) continue;

                    const weight = parseFloat(weightStr) || 1.0;
                    const item = { text, weight };

                    if (type === 'meal') {
                        newMeals.push(item);
                    } else if (type === 'scary') {
                        newStories.push(item);
                    } else if (type === 'dream_symbol' && topic) {
                        newDreamDictionary[topic] = text;
                    } else if (type === 'chat' && topic) {
                        if (!newContexts[topic]) newContexts[topic] = [];
                        newContexts[topic].push(text);
                    }
                }

                if (newMeals.length > 0) mealSuggestions.splice(0, mealSuggestions.length, ...newMeals);
                if (newStories.length > 0) scaryStories.splice(0, scaryStories.length, ...newStories);
                if (Object.keys(newContexts).length > 0) {
                    for (let key in newContexts) {
                        topicContexts[key] = newContexts[key];
                    }
                }
                if (Object.keys(newDreamDictionary).length > 0) {
                    Object.assign(dreamDictionary, newDreamDictionary);
                }
                console.log("Moma room data loaded from Sheet with weights.");
            } catch (e) {
                console.error("Failed to load Moma data from Sheet, using fallbacks.", e);
            }
        }

        function navigateWithTransition(url) {
            const overlay = document.getElementById('transition-overlay');
            overlay.classList.remove('opacity-0');
            overlay.classList.add('opacity-100');
            setTimeout(() => {
                window.location.href = url;
            }, 600);
        }

        function setState(newState, isSmiling = false) {
            state = newState;

            // Reset animations that might conflict (keep position transitions)
            moma.classList.remove('walk', 'breathe');

            // Set Image and Animation based on State
            switch (state) {
                case 'IDLE':
                    momaImg.src = isSmiling ? './moma-idle_02.png' : './moma-idle.png';
                    moma.classList.add('breathe');
                    break;
                case 'WALKING':
                    momaImg.src = isSmiling ? './moma-walk_02.png' : './moma-walk.png';
                    moma.classList.add('walk');
                    break;
                case 'EATING':
                    momaImg.src = './moma-eat_02.png'; // Improved: always use smiling for eating
                    moma.classList.add('breathe');
                    break;
                case 'SLEEPING':
                    momaImg.src = './moma-sleep.png';
                    moma.classList.add('breathe');
                    break;
            }
        }

        // Game Loop for autonomous behavior
        setInterval(() => {
            if (state === 'SLEEPING') return;

            // Random chance to change behavior
            if (Math.random() < 0.05) { // 5% chance every second to pick new action
                decideAction();
            }
        }, 1000);

        function decideAction() {
            if (state === 'EATING') return;

            const rand = Math.random();
            if (rand < 0.6) {
                // Walk to new random position
                walkToRandomSpot();
            } else {
                // Idle (occasionally smile)
                setState('IDLE', Math.random() < 0.3);
            }
        }

        let isWalkingMode = false;
        let walkInterval = null;

        function toggleWalkMode() {
            if (state === 'SLEEPING') return;
            isWalkingMode = !isWalkingMode;

            if (isWalkingMode) {
                document.body.classList.add('walking-mode');
                showBubble("ãŠã•ã‚“ã½ãƒ¢ãƒ¼ãƒ‰ã€ã‚ªãƒ³ã‚‚ã¾ï¼ğŸ¾");
                startContinuousWalk();
            } else {
                document.body.classList.remove('walking-mode');
                showBubble("ãŠã•ã‚“ã½ãŠã‚ã‚Šã‚‚ã¾ï½âœ¨");
                stopContinuousWalk();
            }
        }

        function startContinuousWalk() {
            if (walkInterval) clearInterval(walkInterval);
            walkToRandomSpot();
            walkInterval = setInterval(() => {
                if (isWalkingMode && state !== 'SLEEPING' && state !== 'EATING') {
                    walkToRandomSpot();
                }
            }, 4000);
        }

        function stopContinuousWalk() {
            if (walkInterval) clearInterval(walkInterval);
            walkInterval = null;
            setState('IDLE');
        }

        function getMomaSafeBounds() {
            // Returns the safe pixel coordinates for Moma's top-left corner
            // accounts for character size and room layout
            const charWidth = moma.offsetWidth;
            const charHeight = moma.offsetHeight;

            // Standard Bounds (Desktop/Tablet)
            let minXPercent = 0.28;
            let maxXPercent = 0.72;
            let minYPercent = 0.58;
            let maxYPercent = 0.78;

            // Mobile Enhancements (Wider range to avoid feeling cramped)
            if (window.innerWidth <= 768) {
                minXPercent = 0.10; // Allow moving more to the left
                maxXPercent = 0.90; // Allow moving more to the right
                minYPercent = 0.50; // Use more vertical space
                maxYPercent = 0.80;
            }

            const minX = width * minXPercent;
            const maxX = Math.max(minX, width * maxXPercent - charWidth);
            const minY = height * minYPercent;
            const maxY = Math.max(minY, height * maxYPercent - charHeight);

            return { minX, maxX, minY, maxY };
        }

        function walkToRandomSpot() {
            if (state === 'EATING') return;

            // Randomly smile while walking
            const smilesWhileWalking = Math.random() < 0.4;
            setState('WALKING', smilesWhileWalking);

            // Dynamic boundaries based on actual background image scaling
            const bounds = getMomaSafeBounds();
            const minX = bounds.minX;
            const maxX = bounds.maxX;
            const minY = bounds.minY;
            const maxY = bounds.maxY;

            const targetX = minX + Math.random() * (maxX - minX);
            const targetY = minY + Math.random() * (maxY - minY);

            // Small delay to "think" before turning and moving
            setTimeout(() => {
                const flip = targetX > momaX ? -1 : 1;
                moma.style.transform = `scaleX(${flip}) scale(0.95)`;

                momaX = targetX;
                momaY = targetY;
                updatePosition();

                setTimeout(() => {
                    moma.style.transform = `scaleX(${flip}) scale(1)`;
                }, 500);
            }, 300);

            setTimeout(() => {
                if (state === 'WALKING' && !isWalkingMode) {
                    setState('IDLE', smilesWhileWalking); // Keep the expression if he was smiling
                }
            }, 2500);
        }

        function updatePosition() {
            const bounds = getMomaSafeBounds();

            // Clamp to safe bounds
            momaX = Math.max(bounds.minX, Math.min(momaX, bounds.maxX));
            momaY = Math.max(bounds.minY, Math.min(momaY, bounds.maxY));

            moma.style.left = momaX + 'px';
            moma.style.top = momaY + 'px';
        }

        function petMoma() {
            if (state === 'SLEEPING') {
                createHeart(momaX + 125, momaY, "ğŸ’¤");
                showBubble("ã™ã‚„ã™ã‚„...ğŸ’¤");
                return;
            }

            // Trigger smile
            setState(state, true);

            // Reaction
            moma.classList.add('animate-bounce');
            createHeart(momaX + 125, momaY);
            showBubble(["ãªã§ãªã§ï½ğŸµ", "ãˆã¸ã¸ã€ã™ãã‚‚ã¾ğŸ’•", "ã‚ã£ãŸã‹ã„ã‚‚ã¾âœ¨"][Math.floor(Math.random() * 3)]);

            setTimeout(() => {
                moma.classList.remove('animate-bounce');
                // Return to neutral or random smile after a bit
                if (state !== 'EATING' && state !== 'SLEEPING') {
                    setState(state, Math.random() < 0.2);
                }
            }, 2000);
        }

        function toggleFoodMenu() {
            if (state === 'SLEEPING') return;
            const menu = document.getElementById('food-menu');
            menu.classList.toggle('active');
        }

        function feedMoma(type = 'meal') {
            document.getElementById('food-menu').classList.remove('active');
            if (state === 'SLEEPING') return;

            setState('EATING');

            let emoji = "ğŸ¥ª";
            let msg = "ã‚‚ãã‚‚ã...ğŸ˜‹";

            if (type === 'meal') {
                emoji = "ğŸš";
                msg = "ã”ã¯ã‚“ãŠã„ã—ã„ã‚‚ã¾ï¼ğŸš";
            } else if (type === 'sweets') {
                emoji = "ğŸ°";
                msg = "ã‚ã¾ï½ã„ï¼ã—ã‚ã‚ã›ã‚‚ã¾ğŸ’•";
            } else if (type === 'drink') {
                emoji = "ğŸ¥¤";
                msg = "ã”ãã”ã...ã·ã¯ãƒ¼ï¼âœ¨";
            }

            createHeart(momaX + 125, momaY - 50, emoji);
            showBubble(msg);

            setTimeout(() => {
                createHeart(momaX + 125, momaY - 50, "â¤ï¸");
                setState('IDLE');
                if (isWalkingMode) startContinuousWalk();
            }, 2000);
        }

        function playBall() {
            if (state === 'SLEEPING') return;
            createHeart(momaX + 125, momaY - 50, "ğŸµ");
            walkToRandomSpot(); // Excitement
        }

        // Night/Sleep Logic
        let audioCtx = null;
        let sleepBgmPlaying = false;

        function createStars() {
            const overlay = document.getElementById('night-overlay');
            overlay.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                star.style.setProperty('--delay', (Math.random() * 5) + 's');
                overlay.appendChild(star);
            }
        }

        function toggleSleepMenu() {
            if (state === 'SLEEPING') {
                wakeUpMoma();
                return;
            }
            const menu = document.getElementById('sleep-menu');
            menu.classList.toggle('active');

            // Close other menus
            document.getElementById('food-menu').classList.remove('active');
        }

        function selectSleepSong(index) {
            document.getElementById('sleep-menu').classList.remove('active');
            sleepMoma(index);
        }

        function playLullaby(index) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Stop any current audio before starting new one
            stopLullaby();
            sleepBgmPlaying = true;

            // Try to play external file if it exists, otherwise fallback to synth
            const audioFile = `song${index}.mp3`;
            console.log("Attempting to play:", audioFile);
            const audio = new Audio(audioFile);
            audio.loop = true;
            window.currentSleepAudio = audio;

            audio.play().catch(e => {
                console.log("Audio file not found or blocked, falling back to synth.", e);
                startSynthLullaby(index);
            });
        }

        function startSynthLullaby(index) {
            // Variation based on index
            const baseNotes = [261.63, 329.63, 392.00, 329.63, 440.00, 392.00, 349.23, 329.63];
            const octaveShift = (index - 1) * 0.1; // Subtle change in pitch
            const notes = baseNotes.map(n => n * (1 + octaveShift));

            let step = 0;

            function playNote() {
                if (!sleepBgmPlaying) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = index % 2 === 0 ? 'sine' : 'triangle'; // Different timbre
                oscillator.frequency.setValueAtTime(notes[step], audioCtx.currentTime);

                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.03, audioCtx.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 3);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 3);

                step = (step + 1) % notes.length;
                setTimeout(playNote, 2500 - (index * 100)); // Slightly different speed
            }
            playNote();
        }

        function stopLullaby() {
            sleepBgmPlaying = false;
            if (window.currentSleepAudio) {
                window.currentSleepAudio.pause();
                window.currentSleepAudio = null;
            }
        }

        function sleepMoma(songIndex = 1) {
            const overlay = document.getElementById('night-overlay');
            setState('SLEEPING');
            moma.style.filter = "brightness(0.8) sepia(0.2)";
            createHeart(momaX + 125, momaY - 50, "ğŸ’¤");
            overlay.style.opacity = '0.8';
            createStars();
            playLullaby(songIndex);
            if (isWalkingMode) stopContinuousWalk();

            const songEmojis = ["ğŸ", "ğŸš", "ğŸ•¯ï¸", "ğŸ§¸", "â˜ï¸"];
            showBubble(`${songEmojis[songIndex - 1]} å¤¢ã®ä¸­ã¸ã„ãã‚‚ã¾...ğŸ’¤`);
        }

        function wakeUpMoma() {
            const overlay = document.getElementById('night-overlay');
            setState('IDLE');
            moma.style.filter = "drop-shadow(0 10px 15px rgba(0,0,0,0.1))";
            createHeart(momaX + 125, momaY - 50, "â˜€ï¸");
            overlay.style.opacity = '0';
            stopLullaby();
            if (isWalkingMode) startContinuousWalk();
            showBubble("ãµã‚ã... ã‚ˆãã­ãŸã‚‚ã¾ï¼â˜€ï¸");
        }

        // --- Nickname System Logic ---
        let userNickname = localStorage.getItem('moma_user_nickname') || '';
        let currentSuggestion = '';

        function openSettings() {
            const settingsModal = document.getElementById('settings-modal');
            const nameDisplay = document.getElementById('current-name-display');
            const resetBtn = document.getElementById('reset-name-btn');

            if (userNickname) {
                nameDisplay.innerText = `ã„ã¾ã®ãŠãªã¾ãˆï¼š${userNickname}`;
                resetBtn.style.display = 'inline-block';
            } else {
                nameDisplay.innerText = 'ãŠãªã¾ãˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                resetBtn.style.display = 'none';
                // Automatically open name input if not registered
                setTimeout(() => {
                    closeModal('settings-modal');
                    openModal('name-modal');
                }, 800);
            }
            settingsModal.style.display = 'flex';
        }

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function requestNickname() {
            const input = document.getElementById('base-name-input');
            const baseName = input.value.trim();

            if (!baseName) {
                alert('ãŠãªã¾ãˆã‚’ã„ã‚Œã¦ã­ï¼');
                return;
            }

            // Check if Hiragana only
            if (!/^[ã-ã‚“ãƒ¼]+$/.test(baseName)) {
                alert('ã²ã‚‰ãŒãªã§ã„ã‚Œã¦ã­âœ¨');
                return;
            }

            const suffixes = ['ã‚Šã‚“', 'ã£ã¡', 'ã‚‚ã¾', 'ã´', 'ã¡ã‚ƒã‚“', 'ãŸã‚“', 'ã«ã‚ƒã‚“', 'ã½ã‚ˆ'];
            currentSuggestion = baseName + suffixes[Math.floor(Math.random() * suffixes.length)];

            document.getElementById('suggestion-text').innerText = `ã€Œ${currentSuggestion}ã€ã¯ã©ã†ã‚‚ã¾ï¼Ÿ`;

            closeModal('name-modal');
            openModal('suggestion-modal');
        }

        function saveNickname() {
            userNickname = currentSuggestion;
            localStorage.setItem('moma_user_nickname', userNickname);
            closeModal('suggestion-modal');
            showBubble(`${userNickname}ã€ã‚ˆã‚ã—ãã‚‚ã¾ï¼ğŸ’•`);

            moma.classList.add('animate-bounce');
            setTimeout(() => moma.classList.remove('animate-bounce'), 1000);
        }

        function resetNickname() {
            if (confirm('ãŠãªã¾ãˆã‚’æ¶ˆã—ã¡ã‚ƒã†ã‚‚ã¾ï¼Ÿ')) {
                userNickname = '';
                localStorage.removeItem('moma_user_nickname');
                closeModal('settings-modal');
                showBubble('ãŠãªã¾ãˆã€ã‚ã™ã‚Œã¡ã‚ƒã£ãŸã‚‚ã¾...ğŸ’§');
            }
        }

        // --- Chat Functions ---
        const topicMenu = document.getElementById('topic-menu');
        const menuTopics = document.getElementById('menu-topics');
        const menuInput = document.getElementById('menu-input');
        const menuInstruction = document.getElementById('menu-instruction');
        const momaBubble = document.getElementById('moma-bubble');
        const userInput = document.getElementById('user-input');

        let currentTopic = '';

        function openChat() {
            if (state === 'SLEEPING') return;
            showTopics();
            topicMenu.style.display = 'flex';
        }

        function showTopics() {
            currentTopic = '';
            menuTopics.style.display = 'flex';
            menuInput.style.display = 'none';
            menuInstruction.innerText = 'ã©ã®ãŠã¯ãªã—ã«ã™ã‚‹ï¼Ÿ';
            userInput.value = '';
        }

        const mealSuggestions = [
            { text: 'å‰é‡å®¶ã®ç‰›ä¸¼ã€ã¤ã‚†ã ãã«ã™ã‚‹ã‚‚ã¾ï¼Ÿ', weight: 1 },
            { text: 'ã‚‚ã¾ã¡ã‚ƒã‚“ã¯ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰ã®ãƒãƒ†ãƒˆãŒé£Ÿã¹ãŸã„ã‚‚ã¾ï½ğŸŸ', weight: 1 },
            { text: 'ãƒ­ãƒƒãƒ†ãƒªã‚¢ã®çµ¶å“ãƒãƒ¼ã‚ºãƒãƒ¼ã‚¬ãƒ¼ã€æ°—ã«ãªã‚‹ã‚‚ã¾ï¼', weight: 1 },
            { text: 'ãŠã“ã®ã¿ã‚„ãé“ã¨ã‚“å €ã§ã€ã½ã‚“ã½ã“ã½ã‚“ã‚‚ã¾ï¼ğŸ¦', weight: 1 },
            { text: 'ã³ã£ãã‚Šãƒ‰ãƒ³ã‚­ãƒ¼ã®ãƒãƒ³ãƒãƒ¼ã‚°ã«ã™ã‚‹ã‚‚ã¾ï¼Ÿ', weight: 1 },
            { text: 'ä¸¸äº€è£½éººã§ã†ã©ã‚“ã¤ã‚‹ã¤ã‚‹ã—ãŸã„ã‚‚ã¾ã­ã‡âœ¨', weight: 1 },
            { text: 'ã‚µã‚¤ã‚¼ãƒªãƒ¤ã®ãƒŸãƒ©ãƒé¢¨ãƒ‰ãƒªã‚¢ã¯é‰„æ¿ã‚‚ã¾ï¼', weight: 1 },
            { text: 'ã‚¹ã‚·ãƒ­ãƒ¼ã§10çš¿ãŸã¹ã‚‹ã‚‚ã¾ï½ğŸ£', weight: 1 },
            { text: 'ãã‚‰å¯¿å¸ã§ã³ã£ãã‚‰ãƒãƒ³å½“ã¦ã‚‹ã‚‚ã¾ï¼ğŸ¯', weight: 1 },
            { text: 'ä»Šæ—¥ã¯ã‚«ãƒ¬ãƒ¼ãƒã‚¦ã‚¹CoCoå£±ç•ªå±‹ã«ã—ã¡ã‚ƒã†ã‚‚ã¾ï¼Ÿ Curry! Curry!', weight: 1 },
            { text: 'é¤ƒå­ã®ç‹å°†ã§ã‚®ãƒ§ãƒ¼ã‚¶ã±ãã±ãã™ã‚‹ã‚‚ã¾ï¼ğŸ¥Ÿ', weight: 1 },
            { text: 'å¤§é˜ªç‹å°†ã®ãµã‚ã¨ã‚å¤©æ´¥é£¯ã‚‚æ¨ã¦ãŒãŸã„ã‚‚ã¾...', weight: 1 },
            { text: 'ãƒ¢ã‚¹ãƒãƒ¼ã‚¬ãƒ¼ã®ãƒ†ãƒªãƒ¤ã‚­ã€ãƒ¬ã‚¿ã‚¹ã—ã‚ƒãã—ã‚ƒãã‚‚ã¾ã‚ˆï½', weight: 1 },
            { text: 'ãªã‹å¯ã®è¦ªå­ä¸¼ã€ãµã‚ã¨ã‚ã‚‚ã¾ã­ã‡', weight: 1 },
            { text: 'å¤©ä¸‹ä¸€å“ã®ã“ã£ã¦ã‚Šãƒ©ãƒ¼ãƒ¡ãƒ³ã€ãŸã¾ã«é£Ÿã¹ãŸããªã‚‹ã‚‚ã¾ï¼', weight: 1 },
            { text: 'ã‚±ãƒ³ã‚¿ãƒƒã‚­ãƒ¼ã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒã‚­ãƒ³ã€ã‚¹ãƒ‘ã‚¤ã‚¹ãã„ã¦ã‚‹ã‚‚ã¾ï¼ğŸ—', weight: 1 },
            { text: 'æ¾å±‹ã®ç‰›ã‚ã—ã€å‘³å™Œæ±ãŒã¤ã„ã¦ãã¦å¬‰ã—ã„ã‚‚ã¾ï¼', weight: 1 },
            { text: 'ã™ãå®¶ã®3ç¨®ã®ãƒãƒ¼ã‚ºç‰›ä¸¼ã€ã¨ã‚ã¨ã‚ã‚‚ã¾ï½ğŸ§€', weight: 1 },
            { text: 'ã‚¬ã‚¹ãƒˆã®ãƒãƒ¼ã‚ºINãƒãƒ³ãƒãƒ¼ã‚°ã€åˆ‡ã‚‹ã¨ã˜ã‚…ã‚ï½ã‚‚ã¾ï¼', weight: 1 },
            { text: 'å¯Œå£«ãã°ã§ã‚µã‚¯ãƒƒã¨ãŠãã°é£Ÿã¹ã‚‹ã‚‚ã¾ï¼Ÿ', weight: 1 },
            { text: 'ç„¼è‚‰ãã‚“ãã§é£Ÿã¹æ”¾é¡Œï¼ãŠãªã‹ã½ã‚“ã½ã‚“ã‚‚ã¾ï¼', weight: 1 },
            { text: 'å¤§æˆ¸å±‹ã®ã—ã¾ã»ã£ã‘å®šé£Ÿã€å¥åº·çš„ã‚‚ã¾ã­ã‡', weight: 1 },
            { text: 'ã‚„ã‚ˆã„è»’ã§ãŠã‹ã‚ã‚Šç„¡é™ãƒ«ãƒ¼ãƒ—ã‚‚ã¾...ï¼ğŸš', weight: 1 },
            { text: 'ã¯ãªã¾ã‚‹ã†ã©ã‚“ã®æ¸©ç‰ã¶ã£ã‹ã‘ã€ã¤ã‚‹ã¤ã‚‹ã‚‚ã¾ï½', weight: 1 },
            { text: 'ç¯‰åœ°éŠ€ã ã“ã®ãŸã“ç„¼ãã€å¤–ã‚«ãƒªä¸­ãƒˆãƒ­ã‚‚ã¾ã‚ˆï¼ğŸ™', weight: 1 },
            { text: 'ã‚µãƒ¼ãƒ†ã‚£ãƒ¯ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚·ãƒ£ãƒ¯ãƒ¼ï¼ãƒ‘ãƒãƒ‘ãƒã‚‚ã¾ï¼ğŸ¨', weight: 1 },
            { text: 'ä¸€è˜­ã§é›†ä¸­ã—ã¦ãƒ©ãƒ¼ãƒ¡ãƒ³ãŸã¹ã‚‹ã‚‚ã¾...ğŸœ', weight: 1 },
            { text: 'ç‰›è§’ã§ç¶²ç„¼ããƒ‘ãƒ¼ãƒ†ã‚£ã‚‚ã¾ï¼ã˜ã‚…ãƒ¼ã˜ã‚…ãƒ¼ï¼ğŸ”¥', weight: 1 },
            { text: 'ã¤ã‚‹ã¨ã‚“ãŸã‚“ã®å¤§ããªå™¨ã€ã³ã£ãã‚Šã™ã‚‹ã‚‚ã¾ã­', weight: 1 },
            { text: 'ãƒŸã‚¹ã‚¿ãƒ¼ãƒ‰ãƒ¼ãƒŠãƒ„ã§ãƒãƒ³ãƒ»ãƒ‡ãƒ»ãƒªãƒ³ã‚°10å€‹ãŸã¹ã‚‹ã‚‚ã¾ï¼ğŸ©', weight: 1 },
            { text: 'ã‚³ãƒ¡ãƒ€çˆç²åº—ã§ã‚·ãƒ­ãƒãƒ¯ãƒ¼ãƒ«é£Ÿã¹ã‚‹ã‚‚ã¾ï¼ŸğŸŒ', weight: 1 },
            { text: 'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ã§æ–°ä½œãƒ•ãƒ©ãƒšãƒãƒ¼ãƒã‚‚ã¾ï¼ğŸ¥¤', weight: 1 },
            { text: 'ã‚µãƒ–ã‚¦ã‚§ã‚¤ã§ãŠé‡èœãŸã£ã·ã‚Šã®ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒã«ã™ã‚‹ã‚‚ã¾ï¼ŸğŸ¥ª', weight: 1 },
            { text: 'æ˜Ÿä¹ƒçˆç²åº—ã®ãµã‚ãµã‚ã‚¹ãƒ•ãƒ¬ãƒ‘ãƒ³ã‚±ãƒ¼ã‚­ã€é£Ÿã¹ãŸã„ã‚‚ã¾ï½ğŸ¥', weight: 1 },
            { text: 'ä»Šæ—¥ã¯å¥®ç™ºã—ã¦ã€ã†ãªãã®è’²ç„¼ã«ã—ã¡ã‚ƒã†ã‚‚ã¾ï¼ŸğŸ', weight: 1 },
            { text: 'ã‚³ã‚³ã‚¹ã§åŒ…ã¿ç„¼ããƒãƒ³ãƒãƒ¼ã‚°ã‚‚ã¾ï¼ã‚ã¤ã‚ã¤ï¼', weight: 1 },
            { text: 'ä¸€é¢¨å ‚ã®ç™½ä¸¸ãƒ»èµ¤ä¸¸ã€ã©ã£ã¡ã«ã™ã‚‹ã‚‚ã¾ï¼ŸğŸœ', weight: 1 },
            { text: 'ãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒãƒ¼ã‚¬ãƒ¼ã®ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãƒãƒ¼ã‚¬ãƒ¼ã‚‚ã¾ï¼ğŸ”', weight: 1 },
            { text: 'ã‚¸ãƒ§ãƒŠã‚µãƒ³ã®ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã§å„ªé›…ãªæœã‚‚ã¾...â˜•', weight: 1 },
            { text: 'ã¦ã‚“ã‚„ã®å¤©ä¸¼ã€ã‚¿ãƒ¬ãŒãŸã¾ã‚‰ãªã„ã‚‚ã¾ã­ã‡ğŸ¤', weight: 1 },
            { text: 'ä»Šæ—¥ã¯è‡ªç‚Šï¼å¡©ã‚€ã™ã³ã‚’ã‚€ã™ã‚“ã§ã‚ã’ã‚‹ã‚‚ã¾ğŸ™', weight: 1 },
            { text: 'ã»ã‹ã»ã‹ã®ãŠå‘³å™Œæ±ã¨ç™½ç±³ã€ä¸€ç•ªã®ã”ã¡ãã†ã‚‚ã¾ï¼ğŸš', weight: 1 },
            { text: 'ã‚‚ã¾ã¡ã‚ƒã‚“ã®ç‰¹è£½ã‚ªãƒ ãƒ©ã‚¤ã‚¹...ã‚ã€è‡ªç‚Šã‚‚å¿œæ´ã™ã‚‹ã‚‚ã¾ï¼ğŸ£', weight: 1 }
        ];

        const scaryStories = [
            { text: 'å¤œä¸­ã«ç›®ãŒè¦šã‚ãŸã‚‰ã€ãŠã‚„ã¤ã®ãƒ—ãƒªãƒ³ãŒå…¨éƒ¨ãªããªã£ã¦ãŸã‚‚ã¾...ï¼çŠ¯äººã¯...ã‚‚ã¾ã¡ã‚ƒã‚“ã ã£ãŸã‚‚ã¾ğŸ‘»ï¼ˆé£Ÿã¹ãŸã®å¿˜ã‚Œã¦ãŸã ã‘ã‚‚ã¾ï¼‰', weight: 1 },
            { text: 'éƒ¨å±‹ã®éš…ã«é»’ã„å½±ãŒ...! ã¨æ€ã£ãŸã‚‰ã€ã‚ãªãŸã®è„±ãã£ã±ãªã—ã®é´ä¸‹ã ã£ãŸã‚‚ã¾ã€‚ã³ã£ãã‚Šã—ã¦ã€ãã‚…ãƒ¼ã—ã¡ã‚ƒã£ãŸã‚‚ã¾ã‚ˆâœ¨', weight: 1 },
            { text: 'ã‚ã‚‹æ—¥ã€ã‚‚ã¾ã¡ã‚ƒã‚“ãŒå‘¼ã‚“ã§ã‚‚è¿”äº‹ãŒãªã„ã‚‚ã¾...ã€‚ã‚‚ã—ã‹ã—ã¦æ¶ˆãˆã¡ã‚ƒã£ãŸï¼ï¼Ÿã¨æ€ã£ãŸã‚‰ã€ã‚‚ã¾ã¡ã‚ƒã‚“ãŒãŠæ˜¼å¯ã—ã¦ãŸã ã‘ã ã£ãŸã‚‚ã¾ğŸ’¤ ã³ã£ãã‚Šã—ãŸã‚‚ã¾ã€œ', weight: 1 },
            { text: 'å¤œã«ãŠæ•£æ­©ã—ã¦ãŸã‚‰ã€Œã†ã‚‰ã‚ã—ã‚„ã€œã€ã£ã¦èã“ãˆãŸã‚‚ã¾ï¼ã§ã‚‚ã‚ˆãèã„ãŸã‚‰ã€Œã†ã‚‰ã‚ã—ã‚…ã‚„ã€œã€ãŠãªã‹ãŒç©ºã„ãŸã‚‚ã¾...ã€ã£ã¦ãŠè…¹ã®éŸ³ã ã£ãŸã‚‚ã¾ğŸ™', weight: 1 },
            { text: 'é¡ã‚’è¦‹ãŸã‚‰ã€ãã“ã«ã¯è‡ªåˆ†ãã£ãã‚Šã®å§¿ãŒ...ï¼ã£ã¦ã€ãã‚Œã¯ãŸã ã®é¡ã‚‚ã¾ã­ã€‚ã‚‚ã¾ã¡ã‚ƒã‚“ã€ä»Šæ—¥ã‚‚æœ€é«˜ã«å¯æ„›ã‹ã£ãŸã‚‚ã¾ã€œğŸ’•', weight: 1 },
            { text: 'æš—ã„å»Šä¸‹ã‹ã‚‰ã€Œã‚«ã‚µã‚«ã‚µ...ã€ã£ã¦éŸ³ãŒï¼å‹‡æ°—ã‚’å‡ºã—ã¦è¦‹ã«è¡Œã£ãŸã‚‰ã€ä¸¸ã¾ã£ãŸãƒ¬ã‚·ãƒ¼ãƒˆãŒé¢¨ã«å¹ã‹ã‚Œã¦ãŸã ã‘ã ã£ãŸã‚‚ã¾ã€‚ç´™ããšã‚‚å…ƒæ°—ã‚‚ã¾ã­ã‡âœ¨', weight: 1 },
            { text: 'ã•ã£ãã¾ã§ã‚ã£ãŸã¯ãšã®ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆãŒã€å¿½ç„¶ã¨æ¶ˆãˆãŸã‚‚ã¾...ã€‚ã“ã‚Œã¯ã€ãŠè“å­æ³¥æ£’ã®ä»•æ¥­ã‚‚ã¾ï¼ã‚ã€ã‚‚ã¾ã¡ã‚ƒã‚“ã®å£ã®å‘¨ã‚Šã«ãƒãƒ§ã‚³ãŒã¤ã„ã¦ã‚‹...ï¼ŸğŸ«', weight: 1 },
            { text: 'å¤œã€èª°ã‚‚ã„ãªã„ã¯ãšã®ãƒªãƒ“ãƒ³ã‚°ã‹ã‚‰ç¬‘ã„å£°ãŒ...ã€‚æã‚‹æã‚‹è¦—ã„ãŸã‚‰ã€ãƒ†ãƒ¬ãƒ“ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã¤ã„ã¦ãŠç¬‘ã„ç•ªçµ„ãŒæµã‚Œã¦ãŸã ã‘ã ã£ãŸã‚‚ã¾ã€‚ã³ã£ãã‚Šã—ãŸã‘ã©é¢ç™½ã‹ã£ãŸã‚‚ã¾ï¼ğŸ“º', weight: 1 }
        ];

        let mealHistory = [];
        let scaryHistory = [];

        const dreamDictionary = {
            'è›‡': 'é‡‘é‹ã‚„å†ç”Ÿã®è±¡å¾´ã‚‚ã¾ã€‚è‰¯ã„å¤‰åŒ–ãŒèµ·ãã‚‹å‰è§¦ã‚Œã‹ã‚‚ã¾ï¼ğŸ',
            'ç©º': 'è‡ªç”±ã¸ã®æ†§ã‚Œã‚„ã€å¯èƒ½æ€§ãŒåºƒãŒã£ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã‚‚ã¾ã€‚é«˜ãé£›ã¶ã»ã©çµ¶å¥½èª¿ã‚‚ã¾ï¼â˜ï¸',
            'é€ƒã’ã‚‹': 'ä½•ã‹ã‹ã‚‰ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚’æ„Ÿã˜ã¦ã„ã‚‹ã®ã‹ã‚‚ã¾ã€‚ãŸã¾ã«ã¯ã‚‚ã¾ã¡ã‚ƒã‚“ã¨ä¼‘ã‚€ã‚‚ã¾ã‚ˆã€‚ğŸƒ',
            'è½ã¡ã‚‹': 'ä¸å®‰ã‚„è‡ªä¿¡ã®ãªã•ã‚’è¡¨ã—ã¦ã„ã‚‹ã‚‚ã¾ã€‚ã‚‚ã¾ã¡ã‚ƒã‚“ãŒä¸‹ã§å—ã‘æ­¢ã‚ã‚‹ã‹ã‚‰å¤§ä¸ˆå¤«ã‚‚ã¾ï¼ğŸ§¸',
            'çŒ«': 'ç›´æ„ŸåŠ›ãŒé«˜ã¾ã£ã¦ã„ã‚‹ã‹ã€èª°ã‹ã«ç”˜ãˆãŸã„æ°—æŒã¡ã®è¡¨ã‚Œã‚‚ã¾ã€‚ã‚‚ã¾ã‚‚çŒ«ã¡ã‚ƒã‚“ã¨éŠã³ãŸã„ã‚‚ã¾ï¼ğŸ¾'
        };

        function getWeightedRandom(items, history) {
            // 1. Filter items based on history (exclude if in history)
            let candidates = items.map((item, index) => ({ item, index }))
                .filter(c => !history.includes(c.index));

            // 2. Fallback: if all items are in history, clear half of the history
            if (candidates.length === 0 || (items.length > 5 && candidates.length < items.length * 0.3)) {
                history.splice(0, Math.floor(history.length / 2));
                candidates = items.map((item, index) => ({ item, index }))
                    .filter(c => !history.includes(c.index));
            }

            // 3. Select based on weight
            const totalWeight = candidates.reduce((sum, c) => sum + c.item.weight, 0);
            let random = Math.random() * totalWeight;

            for (const c of candidates) {
                if (random < c.item.weight) {
                    history.push(c.index);
                    if (history.length > items.length * 0.7) history.shift();
                    return c.item.text;
                }
                random -= c.item.weight;
            }
            // Fallback to absolute random if something goes wrong
            return candidates[0].item.text;
        }

        function selectTopic(topic, isAuto = false) {
            if (isAuto && topic === 'ãªã«é£Ÿã¹ã‚ˆã£ã‹ï½') {
                topicMenu.style.display = 'none';
                const suggestion = getWeightedRandom(mealSuggestions, mealHistory);
                showBubble(suggestion);
                return;
            }

            if (isAuto && topic === 'ã“ã‚ã„ã¯ãªã—ã—ã¦') {
                topicMenu.style.display = 'none';
                const story = getWeightedRandom(scaryStories, scaryHistory);
                showBubble(story);
                return;
            }

            if (isAuto && topic === 'å¤¢å ã„ã—ã¦ğŸŒ™') {
                currentTopic = topic;
                menuTopics.style.display = 'none';
                menuInput.style.display = 'flex';
                menuInstruction.innerText = "ã©ã‚“ãªå¤¢ã‚’è¦‹ãŸã‹ã‚‚ã¾ï¼Ÿã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ•™ãˆã¦ã­âœ¨";
                userInput.placeholder = "ä¾‹ï¼šè›‡ãŒå‡ºã¦ããŸã€ç©ºã‚’é£›ã‚“ã ...ãªã©";
                userInput.focus();
                return;
            }
            currentTopic = topic;
            menuTopics.style.display = 'none';
            menuInput.style.display = 'flex';
            menuInstruction.innerText = `ã€Œ${topic}ã€ã«ã¤ã„ã¦ãŠã—ãˆã¦ï¼`;
            userInput.placeholder = "ã“ã“ã«å…¥åŠ›ã—ã¦ã­...";
            userInput.focus();
        }

        function closeChat(e) {
            topicMenu.style.display = 'none';
        }

        const topicContexts = {
            'ãŠã‚„ã¤': ['ãŠã„ã—ãã†ï¼', 'ã‚‚ã¾ã‚‚ãŸã¹ãŸã„ï¼', 'ãŠã‚„ã¤ã‚¿ã‚¤ãƒ ã ã­âœ¨'],
            'ãŠã„ã—ã„ã‚‚ã®': ['ã‚ˆã ã‚ŒãŒã§ã¡ã‚ƒã†...ğŸ¤¤', 'ã„ã„ãªãï½ï¼', 'ã“ã‚“ã©ã„ã£ã—ã‚‡ã«ãŸã¹ã‚ˆï¼Ÿ'],
            'ã“ã‚Œã™ã': ['ãã‚Œã€ã‚‚ã¾ã‚‚ã™ãï¼', 'ãƒãƒƒãƒ”ãƒ¼ã«ãªã‚Œã‚‹ã­âœ¨', 'ã™ã¦ãã ã­ã‡ ğŸ’•'],
            'ã¤ã¾ã‚“ãªã„': ['ãã‚“ãªã¨ãã¯ã€ãŠã©ã‚Šæ˜ã‹ãã†ï¼ğŸ•º', 'ã‚‚ã¾ãŒç¬‘ã‚ã›ã¦ã‚ã’ã‚‹ï¼', 'ã®ã‚“ã³ã‚Šã—ã‚ˆã£ã‹ğŸ’¤'],
            'ãŸã®ã—ï½': ['ã‚ãƒ¼ã„ï¼æœ€é«˜ã ã­ï¼âœ¨', 'ã‚‚ã£ã¨ã‚‚ã£ã¨ãŸã®ã—ã‚‚ã†ï¼', 'ãƒãƒƒãƒ”ãƒ¼ãƒãƒƒãƒ”ãƒ¼ï¼'],
            'ã“ã‚ã„': ['ã‚‚ã¾ãŒãŠã°ã‘ã‚’ã‚„ã£ã¤ã‘ã‚‹ï¼âš”ï¸', 'å¤§ä¸ˆå¤«ã€ã„ã£ã—ã‚‡ã«ã„ã‚‹ã‚ˆğŸ’§', 'ãã‚…ãƒ¼ã£ã¦ã—ã¦ã‚ã’ã‚‹ï¼'],
            'ãã„ã¦ï¼': ['ã†ã‚“ã†ã‚“ã€ãã‚Œã§ãã‚Œã§ï¼ŸğŸ“¢', 'ã³ã£ãã‚Šã—ã¡ã‚ƒã†ã­ï¼', 'ã™ã”ã„ãŠè©±ã ï½ï¼âœ¨'],
            'ãŠã•ã‚“ã½': ['ãŠã•ã‚“ã½ã ã„ã™ãï¼ğŸ¾', 'ã©ã“ã¾ã§ã„ã“ã†ã‹ï¼Ÿ', 'ã—ã£ã½æŒ¯ã£ã¡ã‚ƒã†â™ª'],
            'ã ã„ã™ã': ['ã‚‚ã¾ã‚‚ã›ã‹ã„ã„ã¡ã ã„ã™ãï¼ï¼ğŸ’•', 'ãšã£ã¨ã„ã£ã—ã‚‡ã«ã„ã‚ˆã†ã­///', 'ã¡ã‚…ã£ï¼âœ¨'],
            'ãªã„ã—ã‚‡è©±': ['ã‚‚ã¾ã€å£ã‹ãŸã„ã‚ˆğŸ¤«', 'ãµã‚€ãµã‚€...ç§˜å¯†ã ã­âœ¨', 'ãƒ‰ã‚­ãƒ‰ã‚­ã—ã¡ã‚ƒã†ã­ï¼'],
            'ãŠãªã‹ã¸ã£ãŸ': ['ãã…ï½ã£ã¦ãŠãªã‹ãªã£ã¡ã‚ƒã†ã­ğŸš', 'ãªã«ã‹ã¤ãã‚‹ï¼ï¼Ÿ', 'ã”ã¯ã‚“ã®ã˜ã‹ã‚“ã ãƒ¼ï¼']
        };

        function sendChat() {
            const text = userInput.value.trim();
            if (!text) return;

            topicMenu.style.display = 'none';
            userInput.value = '';

            showBubble('...');

            setTimeout(() => {
                // Affirmative responses for anything the user says
                const affirmativeBase = [
                    "ã†ã‚“ã†ã‚“ã€ãã†ã ã­âœ¨",
                    "ã‚‚ã¾ã¯ã„ã¤ã§ã‚‚ã‚ãªãŸã®å‘³æ–¹ã ã‚ˆğŸ’•",
                    "ã„ã„ã‚“ã ã‚ˆã€ãã®ã¾ã¾ã§å¤§ä¸ˆå¤«ã‚‚ã¾ã€‚",
                    "ãŒã‚“ã°ã£ã¦ã‚‹ã­ã€ãˆã‚‰ã„ãˆã‚‰ã„ã‚‚ã¾ï¼ğŸ’®",
                    "ã‚†ã£ãã‚Šä¼‘ã‚“ã§ã„ã„ã‚“ã ã‚ˆğŸ’¤",
                    "ã‚‚ã¾ã¨ã„ã£ã—ã‚‡ã«ã€ã®ã‚“ã³ã‚Šã—ã‚ˆï¼Ÿâœ¨"
                ];

                if (currentTopic === 'å¤¢å ã„ã—ã¦ğŸŒ™') {
                    showBubble(analyzeDream(text));
                } else {
                    const contextOptions = topicContexts[currentTopic] || affirmativeBase;
                    const response = contextOptions[Math.floor(Math.random() * contextOptions.length)];
                    showBubble(response);
                }

                if (Math.random() < 0.4) {
                    moma.classList.add('animate-bounce');
                    setTimeout(() => moma.classList.remove('animate-bounce'), 1000);
                }
            }, 800);
        }

        function analyzeDream(input) {
            let matches = [];
            for (let symbol in dreamDictionary) {
                if (input.includes(symbol)) {
                    matches.push(dreamDictionary[symbol]);
                }
            }

            if (matches.length > 0) {
                const intro = "ã‚‚ã¾ã¡ã‚ƒã‚“ã®å¤¢å ã„çµæœã‚‚ã¾ï¼âœ¨\n";
                // If many matches, just pick some or join. Increased to 5.
                const result = matches.slice(0, 5).join('\n');
                return intro + result;
            } else {
                return "ãµã‚€ãµã‚€...ä¸æ€è­°ãªå¤¢ã‚‚ã¾ã­ã‡ã€‚ãã‚Œã¯ã‚ãªãŸã®å¿ƒãŒæ–°ã—ã„ä¸–ç•Œã‚’æ±‚ã‚ã¦ã„ã‚‹ã‚µã‚¤ãƒ³ã‹ã‚‚ã¾ï¼âœ¨";
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendChat();
            }
        }

        let bubbleTimer = null;
        function showBubble(text) {
            if (bubbleTimer) clearTimeout(bubbleTimer);

            // Occasionally add name to bubble if registered
            let displayText = text;
            if (userNickname) {
                // Replace 'ã‚ãªãŸ' with nickname
                displayText = text.replace(/ã‚ãªãŸ/g, userNickname);

                // Add name to short or specific texts
                if (Math.random() < 0.3 && !displayText.includes(userNickname) && displayText.length < 20 && displayText !== '...') {
                    const patterns = [
                        `${userNickname}ã€${displayText}`,
                        `${displayText}ã€${userNickname}ï¼`,
                        `${userNickname}ï¼${displayText}`
                    ];
                    displayText = patterns[Math.floor(Math.random() * patterns.length)];
                }
            }

            momaBubble.innerText = displayText;
            momaBubble.style.display = 'block';

            // Position bubble above Moma
            updateBubblePosition();

            // Hide after a while (dynamic duration based on text length)
            const duration = Math.max(5000, 3000 + displayText.length * 100);
            bubbleTimer = setTimeout(() => {
                momaBubble.style.display = 'none';
                bubbleTimer = null;
            }, duration);
        }

        function updateBubblePosition() {
            if (momaBubble.style.display === 'block') {
                const bubbleX = (momaX + 125 - momaBubble.offsetWidth / 2);
                const bubbleY = (momaY - momaBubble.offsetHeight - 20);

                // Clamp within screen horizontal
                const padding = 10;
                const clampedX = Math.max(padding, Math.min(bubbleX, window.innerWidth - momaBubble.offsetWidth - padding));

                // If character is too high, show bubble below instead
                let finalY = bubbleY;
                momaBubble.classList.remove('bubble-below');
                if (bubbleY < 10) {
                    finalY = momaY + moma.offsetHeight + 10;
                    momaBubble.classList.add('bubble-below');
                }

                momaBubble.style.left = clampedX + 'px';
                momaBubble.style.top = finalY + 'px';
            }
        }

        // Update bubble on move
        const originalUpdatePosition = updatePosition;
        updatePosition = function () {
            originalUpdatePosition();
            updateBubblePosition();
        };

        function createHeart(x, y, char = "â¤ï¸") {
            const heart = document.createElement('div');
            heart.classList.add('heart-bubble');
            heart.innerText = char;
            heart.style.left = x + 'px';
            heart.style.top = y + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1500);
        }

        // Handle Window Resize
        window.addEventListener('load', () => {
            width = container.offsetWidth;
            height = container.offsetHeight;
            updatePosition();
            loadMomaData();
        });
        window.addEventListener('resize', () => {
            width = container.offsetWidth;
            height = container.offsetHeight;
            updatePosition(); // Immediately clamp to new window size
        });
    </script>
</body>

</html>