<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÇÇ„Åæ„Å°„ÇÉ„Çì„ÅÆ„ÅäÈÉ®Â±ã - Moma's Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="./moma-idle_02.png">
    <link rel="icon" href="./moma-idle_02.png">
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            overflow: hidden;
        }

        #room-container {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background-image: url('./room-bg-v2.png');
            background-size: cover;
            background-position: center bottom;
            position: relative;
            background-repeat: no-repeat;
            background-color: #fdf6ec;
        }

        /* No need for separate mobile sizing with the new dynamic calculation */
        @media (max-width: 768px) {
            #room-container {
                background-size: cover;
                background-position: center bottom;
            }
        }

        /* Add a subtle overlay to make it look intentionally stylistic and hide bottom edge */
        #room-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.4), transparent);
            pointer-events: none;
            z-index: 1;
        }

        /* Moma-chan Character */
        #moma-character {
            position: absolute;
            width: 250px;
            height: auto;
            transition: top 2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                left 2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.15));
            z-index: 10;
        }

        @media (max-width: 768px) {
            #moma-character {
                width: 160px;
            }
        }

        #moma-character:active {
            transition: none;
            /* Instant feedback on click/pet */
        }

        /* Breathing Animation */
        .breathe {
            animation: breathe 3s ease-in-out infinite;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        /* Walking Animation (bobbing) - made slightly snappier */
        .walk {
            animation: walk 0.4s ease-in-out infinite;
        }

        @keyframes walk {

            0%,
            100% {
                transform: translateY(0) rotate(-2deg);
            }

            50% {
                transform: translateY(-10px) rotate(2deg);
            }
        }

        /* Heart Bubble */
        .heart-bubble {
            position: absolute;
            font-size: 2rem;
            animation: floatUp 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0;
            }

            20% {
                transform: translateY(-10px) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px) scale(1);
                opacity: 0;
            }
        }

        /* UI Controls */
        .ui-panel {
            position: absolute;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.4);
            /* More transparent to show floor */
            backdrop-filter: blur(8px);
            padding: 0.8rem 1.5rem;
            border-radius: 9999px;
            display: flex;
            gap: 1.2rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
            /* Subtle shadow */
            z-index: 30;
            width: max-content;
            max-width: 95vw;
        }

        @media (max-width: 640px) {
            .ui-panel {
                /* Use dynamic viewport safe area if available, otherwise lift it higher */
                bottom: calc(0.6rem + env(safe-area-inset-bottom, 0px));
                padding: 0.4rem 0.5rem;
                gap: 0.3rem;
                border-radius: 1.2rem;
                justify-content: center;
                flex-wrap: nowrap !important;
                width: auto;
                max-width: 98vw;
                background: rgba(255, 255, 255, 0.8);
            }

            button.action-btn {
                width: 2.2rem;
                height: 2.2rem;
                font-size: 0.9rem;
            }

            .settings-btn {
                width: 1.6rem;
                height: 1.6rem;
            }
        }

        button.action-btn {
            font-size: 1.5rem;
            padding: 0.5rem;
            border-radius: 50%;
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 2px solid #E0BBE4;
            transition: all 0.2s;
        }

        button.action-btn:hover {
            transform: scale(1.1);
            background: #FEC8D8;
        }

        /* Settings Button - simplified */
        .settings-btn {
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fdfdfd;
            border: 2px solid #FFDEE9;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .settings-btn:hover {
            background: #f0f0f0;
            transform: rotate(30deg);
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #FFB6C1;
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #FFDEE9;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            text-align: center;
            outline: none;
        }

        .modal-btn-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 8px 20px;
            border-radius: 999px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-confirm {
            background: #FFB6C1;
            color: white;
        }

        .btn-cancel {
            background: #eee;
            color: #666;
        }

        .btn-rethink {
            background: #E0BBE4;
            color: white;
        }

        .btn-reset {
            background: #ffaaaa;
            color: white;
            font-size: 0.8rem;
            margin-top: 1rem;
        }

        .modal-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .moma-suggestion-img {
            width: 100px;
            margin: 0 auto 1rem;
        }

        /* Amoeba Topic Menu */
        #topic-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            background: rgba(255, 240, 245, 0.95);
            display: none;
            /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            backdrop-filter: blur(8px);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .topic-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 800px;
            margin-bottom: 40px;
        }

        .amoeba-btn {
            background: white;
            border: 3px solid #FFDEE9;
            padding: 20px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #ff69b4;
            cursor: pointer;
            transition: all 0.5s ease;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;

            /* Amoeba Shape */
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            animation: morph 8s ease-in-out infinite, float 4s ease-in-out infinite;
        }

        .amoeba-btn:nth-child(even) {
            border-radius: 30% 70% 70% 30% / 50% 60% 40% 50%;
            animation-delay: -2s;
        }

        .amoeba-btn:hover {
            transform: scale(1.1);
            background: #FFE4E1;
            border-color: #FFB6C1;
        }

        /* Today's Fortune Button Style */
        .amoeba-btn.fortune-btn {
            background: #E6E6FA;
            /* Lavender */
            border-color: #9370DB;
            color: #4B0082;
        }

        .amoeba-btn.fortune-btn:hover {
            background: #D8BFD8;
        }

        @media (max-width: 640px) {
            .topic-container {
                gap: 12px;
                margin-bottom: 20px;
            }

            .amoeba-btn {
                padding: 12px 18px;
                font-size: 0.9rem;
                border-width: 2px;
            }

            #moma-look-up {
                width: 120px;
            }
        }

        @keyframes morph {
            0% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }

            50% {
                border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%;
            }

            100% {
                border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        #moma-look-up {
            width: 200px;
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {

            0%,
            100% {
                transform: rotate(-5deg);
            }

            50% {
                transform: rotate(5deg);
            }
        }

        /* Speech Bubble */
        .speech-bubble {
            position: absolute;
            background: white;
            border-radius: 20px;
            padding: 15px 25px;
            color: #333;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
            /* Ensure it appears above modals */
            display: none;
            max-width: 320px;
            text-align: center;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 15px 15px 0;
            border-style: solid;
            border-color: white transparent transparent;
        }

        .speech-bubble.bubble-below::after {
            bottom: auto;
            top: -15px;
            border-width: 0 15px 15px;
            border-color: transparent transparent white;
        }

        /* Chat Input Container */
        .chat-input-container {
            margin-top: 20px;
            display: none;
            /* Hidden until topic selected */
            gap: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 999px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            align-items: center;
            box-sizing: border-box;
        }

        @media (max-width: 640px) {
            .chat-input-container {
                padding: 6px 10px;
                gap: 8px;
            }
        }

        .back-btn {
            background: #eee;
            border: none;
            padding: 5px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
        }

        #user-input {
            border: none;
            outline: none;
            flex-grow: 1;
            font-size: 1rem;
            color: #333;
            min-width: 0;
            background: transparent;
        }

        .send-btn {
            background: #FFB6C1;
            color: white;
            border: none;
            width: 54px;
            height: 54px;
            min-width: 54px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        @media (max-width: 640px) {
            .send-btn {
                width: 44px;
                height: 44px;
                min-width: 44px;
                font-size: 0.75rem;
            }
        }

        .send-btn:hover {
            background: #FF69B4;
            transform: scale(1.05);
        }

        /* Night Sky Effect */
        #night-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #0d1b2a 0%, #1b263b 100%);
            opacity: 0;
            transition: opacity 2s ease-in-out;
            pointer-events: none;
            z-index: 5;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle var(--duration) infinite ease-in-out var(--delay);
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0;
                transform: scale(0.5);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        /* Sub Menu Styling (Food Menu) */
        .sub-menu {
            position: absolute;
            bottom: 7rem;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            padding: 0.8rem;
            border-radius: 20px;
            display: none;
            gap: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            z-index: 40;
            border: 2px solid #FFDEE9;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }

        .sub-menu.active {
            display: flex;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .sub-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 5px;
            border-radius: 12px;
        }

        .sub-btn:hover {
            transform: scale(1.1);
            background: #fff0f5;
        }

        .sub-btn span {
            font-size: 1.5rem;
        }

        .sub-btn label {
            font-size: 0.6rem;
            font-weight: bold;
            color: #888;
            cursor: pointer;
        }

        /* Continuous Walk Indicator */
        .walking-mode .action-btn[onclick="toggleWalkMode()"] {
            background: #FFB6C1;
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.6);
            border-color: #FF69B4;
        }

        /* Transition Overlay */
        #transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.6s ease-in-out;
        }
    </style>
</head>

<body>

    <div id="room-container">
        <!-- Transition Overlay -->
        <div id="transition-overlay"></div>

        <!-- Night Overlay -->
        <div id="night-overlay"></div>

        <!-- Moma-chan -->
        <div id="moma-character" class="breathe" onclick="petMoma()">
            <img id="moma-img" src="./moma-idle.png" alt="Moma-chan" style="width: 100%; pointer-events: none;">
        </div>

        <!-- Food Sub Menu -->
        <div id="food-menu" class="sub-menu">
            <div class="sub-btn" onclick="feedMoma('meal')">
                <span>üçö</span>
                <label>„Åî„ÅØ„Çì</label>
            </div>
            <div class="sub-btn" onclick="feedMoma('sweets')">
                <span>üç∞</span>
                <label>„Åä„ÇÑ„Å§</label>
            </div>
            <div class="sub-btn" onclick="feedMoma('drink')">
                <span>ü•§</span>
                <label>„ÅÆ„Åø„ÇÇ„ÅÆ</label>
            </div>
        </div>

        <!-- Sleep Sub Menu -->
        <div id="sleep-menu" class="sub-menu">
            <div class="sub-btn" onclick="selectSleepSong(1)">
                <span>üéê</span>
                <label>„Åã„Åú</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(2)">
                <span>üêö</span>
                <label>„Å™„Åø</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(3)">
                <span>üïØÔ∏è</span>
                <label>„Å®„ÇÇ„Åó„Å≥</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(4)">
                <span>üß∏</span>
                <label>„Åæ„Å©„Çç„Åø</label>
            </div>
            <div class="sub-btn" onclick="selectSleepSong(5)">
                <span>‚òÅÔ∏è</span>
                <label>„Åè„ÇÇ</label>
            </div>
        </div>

        <!-- UI Controls (Tamagotchi Style) -->
        <div class="ui-panel">
            <button class="action-btn" onclick="toggleFoodMenu()" title="„Å™„Å´„Åã„Åü„Åπ„ÇãÔºü">ü•™</button>
            <button class="action-btn" onclick="toggleWalkMode()" title="„Åä„Åï„Çì„ÅΩ„É¢„Éº„Éâ">üêæ</button>
            <button class="action-btn" onclick="openChat()" title="„Åä„ÅØ„Å™„Åó">üí¨</button>
            <button class="action-btn" onclick="toggleSleepMenu()" title="Â§¢„ÅÆ‰∏≠„Å∏">üåô</button>
            <button class="action-btn bg-slate-100" onclick="navigateWithTransition('index.html')"
                title="„ÇÇ„Å©„Çã">üè†</button>
            <button class="settings-btn" title="„Åä„Å™„Åæ„Åà" onclick="openSettings()">üìõ</button>
        </div>

        <!-- Topic Menu -->
        <div id="topic-menu" onclick="closeChat(event)">
            <div class="topic-container" id="menu-topics" onclick="event.stopPropagation()">
                <button class="amoeba-btn" onclick="selectTopic('„Åä„ÇÑ„Å§')">„Åä„ÇÑ„Å§üç≠</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åä„ÅÑ„Åó„ÅÑ„ÇÇ„ÅÆ')">„Åä„ÅÑ„Åó„ÅÑ„ÇÇ„ÅÆüòã</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åì„Çå„Åô„Åç')">„Åì„Çå„Åô„Åç‚ù§Ô∏è</button>
                <button class="amoeba-btn" onclick="selectTopic('„Å§„Åæ„Çì„Å™„ÅÑ')">„Å§„Åæ„Çì„Å™„ÅÑüí§</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åü„ÅÆ„ÅóÔΩû')">„Åü„ÅÆ„Åó„Äú‚ú®</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åì„Çè„ÅÑ')">„Åì„Çè„ÅÑüíß</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åç„ÅÑ„Å¶ÔºÅ')">„Åç„ÅÑ„Å¶ÔºÅüì¢</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åä„Åï„Çì„ÅΩ')">„Åä„Åï„Çì„ÅΩüêæ</button>
                <button class="amoeba-btn" onclick="selectTopic('„Å†„ÅÑ„Åô„Åç')">„Å†„ÅÑ„Åô„Åçüíï</button>
                <button class="amoeba-btn" onclick="selectTopic('„Å™„ÅÑ„Åó„ÇáË©±')">„Å™„ÅÑ„Åó„ÇáË©±ü§´</button>
                <button class="amoeba-btn fortune-btn" onclick="selectTopic('‰ªäÊó•„ÅÆÈÅãÂã¢Êïô„Åà„Å¶üîÆ', true)">‰ªäÊó•„ÅÆÈÅãÂã¢Êïô„Åà„Å¶üîÆ</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åä„Å™„Åã„Å∏„Å£„Åü')">„Åä„Å™„Åã„Å∏„Å£„Åü</button>
                <button class="amoeba-btn" onclick="selectTopic('„Å™„Å´È£ü„Åπ„Çà„Å£„ÅãÔΩû', true)">„Å™„Å´È£ü„Åπ„Çà„Å£„ÅãÔΩûüç¥</button>
                <button class="amoeba-btn" onclick="selectTopic('„Åì„Çè„ÅÑ„ÅØ„Å™„Åó„Åó„Å¶', true)">„Åì„Çè„ÅÑ„ÅØ„Å™„Åó„Åó„Å¶üëª</button>
                <button class="amoeba-btn" onclick="selectTopic('Â§¢Âç†„ÅÑ„Åó„Å¶üåô', true)">Â§¢Âç†„ÅÑ„Åó„Å¶üåô</button>
                <button class="amoeba-btn" style="background: #E0BBE4; color: white;"
                    onclick="selectTopic('„Éê„Ç§„Ç™„É™„Ç∫„É†Ë¶ã„Åõ„Å¶üìà', true)">„Éê„Ç§„Ç™„É™„Ç∫„É†Ë¶ã„Åõ„Å¶üìà</button>
            </div>

            <div class="chat-input-container" id="menu-input" onclick="event.stopPropagation()">
                <button class="back-btn" onclick="showTopics()">‚Üê</button>
                <input type="text" id="user-input" placeholder="„ÇÇ„Åæ„Å°„ÇÉ„Çì„Å´„Å™„Å´„ÅãË©±„Åó„Å¶..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendChat()">ÈÄÅ‰ø°</button>
            </div>

            <p id="menu-instruction" class="mt-4 text-pink-400 font-bold">„Å©„ÅÆ„Åä„ÅØ„Å™„Åó„Å´„Åô„ÇãÔºü</p>
            <img src="./moma-idle.png" id="moma-look-up" alt="looking up moma">
        </div>

        <!-- Name Registration Modal -->
        <div id="name-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">„Åä„Å™„Åæ„Åà„Çí„Åä„Åó„Åà„Å¶ÔºÅ</div>
                <p class="text-xs text-gray-400 mb-4">„Å≤„Çâ„Åå„Å™„Åß„ÅÑ„Çå„Å¶„Å≠‚ú®</p>
                <input type="text" id="base-name-input" class="modal-input" placeholder="„Å™„Åæ„ÅàÔºà„Å≤„Çâ„Åå„Å™Ôºâ" maxlength="10">
                <div class="modal-btn-container">
                    <button class="modal-btn btn-cancel" onclick="closeModal('name-modal')">„ÇÑ„ÇÅ„Å®„Åè</button>
                    <button class="modal-btn btn-confirm" onclick="requestNickname()">„Åä„Åó„Åà„ÇãÔºÅ</button>
                </div>
            </div>
        </div>

        <!-- Nickname Suggestion Modal -->
        <div id="suggestion-modal" class="modal-overlay">
            <div class="modal-content">
                <img src="./moma-idle.png" class="moma-suggestion-img" alt="thinking moma">
                <div id="suggestion-text" class="modal-title">„Äå‚óã‚óã„Çä„Çì„Äç„ÅØ„Å©„ÅÜ„ÇÇ„ÅæÔºü</div>
                <div class="modal-btn-container">
                    <button class="modal-btn btn-confirm" onclick="saveNickname()">„ÅÑ„ÅÑ„Å≠ÔºÅ‚ú®</button>
                    <button class="modal-btn btn-rethink" onclick="requestNickname()">„Å°„Åå„ÅÜ„ÅÆÔºÅ</button>
                    <button class="modal-btn btn-cancel" onclick="closeModal('suggestion-modal')">„ÇÑ„Å∞„Çä„ÅÑ„ÅÑ„ÇÑ</button>
                </div>
            </div>
        </div>

        <!-- Settings/Reset Modal -->
        <div id="settings-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">„Åõ„Å£„Å¶„ÅÑ</div>
                <div id="current-name-display" class="mb-4 text-gray-600"></div>
                <button id="reset-name-btn" class="modal-btn btn-reset" onclick="resetNickname()"
                    style="display:none;">„Åä„Å™„Åæ„Åà„ÅÆÁôªÈå≤„Çí„Åë„Åô</button>

                <!-- Name Registration (If not set) -->
                <div id="settings-name-input-container" class="mt-4" style="display:none;">
                    <p class="text-xs text-gray-400 mb-2">„Åä„Å™„Åæ„Åà„Çí„Åä„Åó„Åà„Å¶„Å≠ÔºÅ(„Å≤„Çâ„Åå„Å™)</p>
                    <input type="text" id="settings-name-input" class="modal-input" placeholder="„Å™„Åæ„Åà" maxlength="10">
                    <button class="modal-btn btn-confirm" style="margin-top:5px;"
                        onclick="requestNicknameFromSettings()">Ê±∫ÂÆö</button>
                </div>

                <div class="mt-4">
                    <label
                        style="color: #FFB6C1; font-weight: bold; display: block; margin-bottom: 5px;">„ÅäË™ïÁîüÊó•Ôºà‰ªªÊÑèÔºâ</label>
                    <input type="date" id="birthdate-input" class="modal-input" style="font-family: inherit;">
                </div>
                <div class="mt-4">
                    <button class="modal-btn btn-confirm" onclick="saveBirthdate(this)">‰øùÂ≠ò„Åô„Çã</button>
                    <button class="modal-btn btn-cancel" onclick="closeModal('settings-modal')">„Å®„Åò„Çã</button>
                </div>
            </div>
        </div>

        <!-- Biorhythm Modal -->
        <div id="biorhythm-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-title">üìâ „ÇÇ„Åæ„Å°„ÇÉ„ÇìÂÅ•Â∫∑Ë®∫Êñ≠ üìà</div>
                <div id="bio-graph-container"
                    style="width: 100%; height: 200px; background: #fffaf0; border-radius: 10px; border: 2px solid #FFE4E1; position: relative; overflow: hidden; margin-bottom: 15px;">
                    <!-- SVG Graph will be inserted here -->
                    <svg id="bio-svg" width="100%" height="100%" viewBox="0 0 300 150" preserveAspectRatio="none">
                        <!-- Grid lines -->
                        <line x1="0" y1="75" x2="300" y2="75" stroke="#ddd" stroke-dasharray="4" />
                        <line x1="150" y1="0" x2="150" y2="150" stroke="#ddd" stroke-width="2" />

                        <!-- Paths -->
                        <path id="bio-physical" stroke="#FFB6C1" stroke-width="3" fill="none" stroke-linecap="round" />
                        <path id="bio-emotional" stroke="#87CEEB" stroke-width="3" fill="none" stroke-linecap="round" />
                        <path id="bio-intellectual" stroke="#98FB98" stroke-width="3" fill="none"
                            stroke-linecap="round" />
                    </svg>
                    <div style="position: absolute; top: 5px; left: 155px; font-size: 0.8rem; color: #888;">Today</div>
                </div>
                <div style="display: flex; justify-content: space-around; font-size: 0.8rem; margin-bottom: 15px;">
                    <span style="color: #FFB6C1;">‚óè ‰ΩìË™ø(P)</span>
                    <span style="color: #87CEEB;">‚óè Ê∞óÂàÜ(E)</span>
                    <span style="color: #98FB98;">‚óè Áü•ÊÄß(I)</span>
                </div>
                <div id="bio-message" style="margin-bottom: 15px; font-weight: bold; color: #555;">
                    „Éá„Éº„Çø„Åå„Å™„ÅÑ„ÇÇ„Åæ...„ÅäË™ïÁîüÊó•„ÇíÊïô„Åà„Å¶„Å≠ÔºÅ
                </div>
                <button class="modal-btn btn-cancel" onclick="closeModal('biorhythm-modal')">„Å®„Åò„Çã</button>
            </div>
        </div>

        <!-- Response Bubble -->
        <div id="moma-bubble" class="speech-bubble"></div>
    </div>

    <script>
        const MOMA_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzI3aafv2e1g9Zqpx3FntaYVSua-LulJIPolrEz_QwfS8w8TjmDp2PNfuU-oqX71yGhYzIqGpQcbV8/pub?gid=0&single=true&output=csv";

        const moma = document.getElementById('moma-character');
        const momaImg = document.getElementById('moma-img');
        const container = document.getElementById('room-container');

        let state = 'IDLE'; // IDLE, WALKING, EATING, SLEEPING
        let width = container.offsetWidth;
        let height = container.offsetHeight;
        let momaX = width / 2 - 125;
        let momaY = height / 2 + 100;

        // Initialize Position
        updatePosition();
        setState('IDLE', false); // Ensure initial state is set correctly with image

        async function loadMomaData() {
            if (!MOMA_SHEET_URL) return;
            try {
                const response = await fetch(MOMA_SHEET_URL);
                const csvText = await response.text();
                const rows = [];
                const lines = csvText.split(/\r?\n/);
                for (let line of lines) {
                    if (!line.trim()) continue;
                    const row = [];
                    let cur = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                cur += '"'; i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            row.push(cur.trim());
                            cur = '';
                        } else {
                            cur += char;
                        }
                    }
                    row.push(cur.trim());
                    rows.push(row);
                }

                const newMeals = [];
                const newStories = [];
                const newContexts = {};
                const newDreamDictionary = {};

                for (let i = 1; i < rows.length; i++) {
                    const [type, topic, text, weightStr] = rows[i];
                    if (!text) continue;

                    const weight = parseFloat(weightStr) || 1.0;
                    const item = { text, weight };

                    if (type === 'meal') {
                        newMeals.push(item);
                    } else if (type === 'scary') {
                        newStories.push(item);
                    } else if (type === 'dream_symbol' && topic) {
                        newDreamDictionary[topic] = text;
                    } else if (type === 'chat' && topic) {
                        if (!newContexts[topic]) newContexts[topic] = [];
                        newContexts[topic].push(text);
                    }
                }

                if (newMeals.length > 0) mealSuggestions.splice(0, mealSuggestions.length, ...newMeals);
                if (newStories.length > 0) scaryStories.splice(0, scaryStories.length, ...newStories);
                if (Object.keys(newContexts).length > 0) {
                    for (let key in newContexts) {
                        topicContexts[key] = newContexts[key];
                    }
                }
                if (Object.keys(newDreamDictionary).length > 0) {
                    Object.assign(dreamDictionary, newDreamDictionary);
                }
                console.log("Moma room data loaded from Sheet with weights.");
            } catch (e) {
                console.error("Failed to load Moma data from Sheet, using fallbacks.", e);
            }
        }

        function navigateWithTransition(url) {
            const overlay = document.getElementById('transition-overlay');
            overlay.classList.remove('opacity-0');
            overlay.classList.add('opacity-100');
            setTimeout(() => {
                window.location.href = url;
            }, 600);
        }

        function setState(newState, isSmiling = false) {
            state = newState;

            // Reset animations that might conflict (keep position transitions)
            moma.classList.remove('walk', 'breathe');

            // Set Image and Animation based on State
            switch (state) {
                case 'IDLE':
                    momaImg.src = isSmiling ? './moma-idle_02.png' : './moma-idle.png';
                    moma.classList.add('breathe');
                    break;
                case 'WALKING':
                    momaImg.src = isSmiling ? './moma-walk_02.png' : './moma-walk.png';
                    moma.classList.add('walk');
                    break;
                case 'EATING':
                    momaImg.src = './moma-eat_02.png'; // Improved: always use smiling for eating
                    moma.classList.add('breathe');
                    break;
                case 'SLEEPING':
                    momaImg.src = './moma-sleep.png';
                    moma.classList.add('breathe');
                    break;
            }
        }

        // Game Loop for autonomous behavior
        setInterval(() => {
            if (state === 'SLEEPING') return;

            // Random chance to change behavior
            if (Math.random() < 0.05) { // 5% chance every second to pick new action
                decideAction();
            }
        }, 1000);

        function decideAction() {
            if (state === 'EATING') return;

            const rand = Math.random();
            if (rand < 0.6) {
                // Walk to new random position
                walkToRandomSpot();
            } else {
                // Idle (occasionally smile)
                setState('IDLE', Math.random() < 0.3);
            }
        }

        let isWalkingMode = false;
        let walkInterval = null;

        function toggleWalkMode() {
            if (state === 'SLEEPING') return;
            isWalkingMode = !isWalkingMode;

            if (isWalkingMode) {
                document.body.classList.add('walking-mode');
                showBubble("„Åä„Åï„Çì„ÅΩ„É¢„Éº„Éâ„ÄÅ„Ç™„É≥„ÇÇ„ÅæÔºÅüêæ");
                startContinuousWalk();
            } else {
                document.body.classList.remove('walking-mode');
                showBubble("„Åä„Åï„Çì„ÅΩ„Åä„Çè„Çä„ÇÇ„ÅæÔΩû‚ú®");
                stopContinuousWalk();
            }
        }

        function startContinuousWalk() {
            if (walkInterval) clearInterval(walkInterval);
            walkToRandomSpot();
            walkInterval = setInterval(() => {
                if (isWalkingMode && state !== 'SLEEPING' && state !== 'EATING') {
                    walkToRandomSpot();
                }
            }, 4000);
        }

        function stopContinuousWalk() {
            if (walkInterval) clearInterval(walkInterval);
            walkInterval = null;
            setState('IDLE');
        }

        function getMomaSafeBounds() {
            // Returns the safe pixel coordinates for Moma's top-left corner
            // accounts for character size and room layout
            const charWidth = moma.offsetWidth;
            const charHeight = moma.offsetHeight;

            // Standard Bounds (Desktop/Tablet)
            let minXPercent = 0.28;
            let maxXPercent = 0.72;
            let minYPercent = 0.58;
            let maxYPercent = 0.78;

            // Mobile Enhancements (Wider range to avoid feeling cramped)
            if (window.innerWidth <= 768) {
                minXPercent = 0.10; // Allow moving more to the left
                maxXPercent = 0.90; // Allow moving more to the right
                minYPercent = 0.50; // Use more vertical space
                maxYPercent = 0.80;
            }

            const minX = width * minXPercent;
            const maxX = Math.max(minX, width * maxXPercent - charWidth);
            const minY = height * minYPercent;
            const maxY = Math.max(minY, height * maxYPercent - charHeight);

            return { minX, maxX, minY, maxY };
        }

        function walkToRandomSpot() {
            if (state === 'EATING') return;

            // Randomly smile while walking
            const smilesWhileWalking = Math.random() < 0.4;
            setState('WALKING', smilesWhileWalking);

            // Dynamic boundaries based on actual background image scaling
            const bounds = getMomaSafeBounds();
            const minX = bounds.minX;
            const maxX = bounds.maxX;
            const minY = bounds.minY;
            const maxY = bounds.maxY;

            const targetX = minX + Math.random() * (maxX - minX);
            const targetY = minY + Math.random() * (maxY - minY);

            // Small delay to "think" before turning and moving
            setTimeout(() => {
                const flip = targetX > momaX ? -1 : 1;
                moma.style.transform = `scaleX(${flip}) scale(0.95)`;

                momaX = targetX;
                momaY = targetY;
                updatePosition();

                setTimeout(() => {
                    moma.style.transform = `scaleX(${flip}) scale(1)`;
                }, 500);
            }, 300);

            setTimeout(() => {
                if (state === 'WALKING' && !isWalkingMode) {
                    setState('IDLE', smilesWhileWalking); // Keep the expression if he was smiling
                }
            }, 2500);
        }

        function updatePosition() {
            const bounds = getMomaSafeBounds();

            // Clamp to safe bounds
            momaX = Math.max(bounds.minX, Math.min(momaX, bounds.maxX));
            momaY = Math.max(bounds.minY, Math.min(momaY, bounds.maxY));

            moma.style.left = momaX + 'px';
            moma.style.top = momaY + 'px';
        }

        function petMoma() {
            if (state === 'SLEEPING') {
                createHeart(momaX + 125, momaY, "üí§");
                showBubble("„Åô„ÇÑ„Åô„ÇÑ...üí§");
                return;
            }

            // Trigger smile
            setState(state, true);

            // Reaction
            moma.classList.add('animate-bounce');
            createHeart(momaX + 125, momaY);
            showBubble(["„Å™„Åß„Å™„ÅßÔΩûüéµ", "„Åà„Å∏„Å∏„ÄÅ„Åô„Åç„ÇÇ„Åæüíï", "„ÅÇ„Å£„Åü„Åã„ÅÑ„ÇÇ„Åæ‚ú®"][Math.floor(Math.random() * 3)]);

            setTimeout(() => {
                moma.classList.remove('animate-bounce');
                // Return to neutral or random smile after a bit
                if (state !== 'EATING' && state !== 'SLEEPING') {
                    setState(state, Math.random() < 0.2);
                }
            }, 2000);
        }

        function toggleFoodMenu() {
            if (state === 'SLEEPING') return;
            const menu = document.getElementById('food-menu');
            menu.classList.toggle('active');
        }

        function feedMoma(type = 'meal') {
            document.getElementById('food-menu').classList.remove('active');
            if (state === 'SLEEPING') return;

            setState('EATING');

            let emoji = "ü•™";
            let msg = "„ÇÇ„Åê„ÇÇ„Åê...üòã";

            if (type === 'meal') {
                emoji = "üçö";
                msg = "„Åî„ÅØ„Çì„Åä„ÅÑ„Åó„ÅÑ„ÇÇ„ÅæÔºÅüçö";
            } else if (type === 'sweets') {
                emoji = "üç∞";
                msg = "„ÅÇ„ÅæÔΩû„ÅÑÔºÅ„Åó„ÅÇ„Çè„Åõ„ÇÇ„Åæüíï";
            } else if (type === 'drink') {
                emoji = "ü•§";
                msg = "„Åî„Åè„Åî„Åè...„Å∑„ÅØ„ÉºÔºÅ‚ú®";
            }

            createHeart(momaX + 125, momaY - 50, emoji);
            showBubble(msg);

            setTimeout(() => {
                createHeart(momaX + 125, momaY - 50, "‚ù§Ô∏è");
                setState('IDLE');
                if (isWalkingMode) startContinuousWalk();
            }, 2000);
        }

        function playBall() {
            if (state === 'SLEEPING') return;
            createHeart(momaX + 125, momaY - 50, "üéµ");
            walkToRandomSpot(); // Excitement
        }

        // Night/Sleep Logic
        let audioCtx = null;
        let sleepBgmPlaying = false;

        function createStars() {
            const overlay = document.getElementById('night-overlay');
            overlay.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.setProperty('--duration', (Math.random() * 3 + 2) + 's');
                star.style.setProperty('--delay', (Math.random() * 5) + 's');
                overlay.appendChild(star);
            }
        }

        function toggleSleepMenu() {
            if (state === 'SLEEPING') {
                wakeUpMoma();
                return;
            }
            const menu = document.getElementById('sleep-menu');
            menu.classList.toggle('active');

            // Close other menus
            document.getElementById('food-menu').classList.remove('active');
        }

        function selectSleepSong(index) {
            document.getElementById('sleep-menu').classList.remove('active');
            sleepMoma(index);
        }

        function playLullaby(index) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // Stop any current audio before starting new one
            stopLullaby();
            sleepBgmPlaying = true;

            // Try to play external file if it exists, otherwise fallback to synth
            const audioFile = `song${index}.mp3`;
            console.log("Attempting to play:", audioFile);
            const audio = new Audio(audioFile);
            audio.loop = true;
            window.currentSleepAudio = audio;

            audio.play().catch(e => {
                console.log("Audio file not found or blocked, falling back to synth.", e);
                startSynthLullaby(index);
            });
        }

        function startSynthLullaby(index) {
            // Variation based on index
            const baseNotes = [261.63, 329.63, 392.00, 329.63, 440.00, 392.00, 349.23, 329.63];
            const octaveShift = (index - 1) * 0.1; // Subtle change in pitch
            const notes = baseNotes.map(n => n * (1 + octaveShift));

            let step = 0;

            function playNote() {
                if (!sleepBgmPlaying) return;
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = index % 2 === 0 ? 'sine' : 'triangle'; // Different timbre
                oscillator.frequency.setValueAtTime(notes[step], audioCtx.currentTime);

                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.03, audioCtx.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 3);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 3);

                step = (step + 1) % notes.length;
                setTimeout(playNote, 2500 - (index * 100)); // Slightly different speed
            }
            playNote();
        }

        function stopLullaby() {
            sleepBgmPlaying = false;
            if (window.currentSleepAudio) {
                window.currentSleepAudio.pause();
                window.currentSleepAudio = null;
            }
        }

        function sleepMoma(songIndex = 1) {
            const overlay = document.getElementById('night-overlay');
            setState('SLEEPING');
            moma.style.filter = "brightness(0.8) sepia(0.2)";
            createHeart(momaX + 125, momaY - 50, "üí§");
            overlay.style.opacity = '0.8';
            createStars();
            playLullaby(songIndex);
            if (isWalkingMode) stopContinuousWalk();

            const songEmojis = ["üéê", "üêö", "üïØÔ∏è", "üß∏", "‚òÅÔ∏è"];
            showBubble(`${songEmojis[songIndex - 1]} Â§¢„ÅÆ‰∏≠„Å∏„ÅÑ„Åè„ÇÇ„Åæ...üí§`);
        }

        function wakeUpMoma() {
            const overlay = document.getElementById('night-overlay');
            setState('IDLE');
            moma.style.filter = "drop-shadow(0 10px 15px rgba(0,0,0,0.1))";
            createHeart(momaX + 125, momaY - 50, "‚òÄÔ∏è");
            overlay.style.opacity = '0';
            stopLullaby();
            if (isWalkingMode) startContinuousWalk();
            showBubble("„Åµ„ÅÇ„ÅÅ... „Çà„Åè„Å≠„Åü„ÇÇ„ÅæÔºÅ‚òÄÔ∏è");
        }

        // --- Nickname System Logic ---
        let userNickname = localStorage.getItem('moma_user_nickname') || '';
        let currentSuggestion = '';

        function openSettings() {
            const settingsModal = document.getElementById('settings-modal');
            const nameDisplay = document.getElementById('current-name-display');
            const resetBtn = document.getElementById('reset-name-btn');
            const nameInputContainer = document.getElementById('settings-name-input-container');

            if (userNickname) {
                nameDisplay.innerText = `„ÅÑ„Åæ„ÅÆ„Åä„Å™„Åæ„ÅàÔºö${userNickname}`;
                resetBtn.style.display = 'inline-block';
                nameInputContainer.style.display = 'none';
            } else {
                nameDisplay.innerText = '„Åä„Å™„Åæ„Åà„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì';
                resetBtn.style.display = 'none';
                nameInputContainer.style.display = 'block';
            }
            openModal('settings-modal');
        }

        function requestNicknameFromSettings() {
            const input = document.getElementById('settings-name-input');
            const baseName = input.value.trim();

            if (!baseName) {
                alert('„Åä„Å™„Åæ„Åà„Çí„ÅÑ„Çå„Å¶„Å≠ÔºÅ');
                return;
            }

            if (!/^[„ÅÅ-„Çì„Éº]+$/.test(baseName)) {
                alert('„Å≤„Çâ„Åå„Å™„Åß„ÅÑ„Çå„Å¶„Å≠‚ú®');
                return;
            }

            const suffixes = ['„Çä„Çì', '„Å£„Å°', '„ÇÇ„Åæ', '„Å¥', '„Å°„ÇÉ„Çì', '„Åü„Çì', '„Å´„ÇÉ„Çì', '„ÅΩ„Çà'];
            currentSuggestion = baseName + suffixes[Math.floor(Math.random() * suffixes.length)];

            document.getElementById('suggestion-text').innerText = `„Äå${currentSuggestion}„Äç„ÅØ„Å©„ÅÜ„ÇÇ„ÅæÔºü`;

            // Close settings and open suggestion
            _internalCloseModal('settings-modal');
            openModal('suggestion-modal');
        }

        // --- History & UI State Management ---
        function openModal(id) {
            // Push state if not already handled by popstate
            // If we are already in a modal state, we might want to push another or replace
            // For simplicity, we stack them.
            history.pushState({ ui: 'modal', id: id }, '', `#${id}`);
            _internalOpenModal(id);
        }

        function _internalOpenModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            // Instead of hiding directly, we go back in history.
            // This triggers popstate > _internalCloseAll
            // Check if we have history state to pop? 
            // If the user loaded the page with a hash, history.state might be null but length > 1
            // Safe fallback: just history.back() if we think we are in a state.
            if (history.state && history.state.ui === 'modal' && history.state.id === id) {
                history.back();
            } else {
                _internalCloseModal(id);
            }
        }

        function _internalCloseModal(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        }

        // Global popstate handler
        window.addEventListener('popstate', (event) => {
            // Close everything first (simplest way to ensure clean slate)
            _internalCloseAllOverlays();

            // Restore based on state
            if (event.state) {
                if (event.state.ui === 'modal') {
                    _internalOpenModal(event.state.id);
                } else if (event.state.ui === 'menu') {
                    _internalOpenChat();
                }
            }
        });

        function _internalCloseAllOverlays() {
            const modals = document.querySelectorAll('.modal-overlay');
            modals.forEach(m => m.style.display = 'none');
            document.getElementById('topic-menu').style.display = 'none';
        }

        function requestNickname() {
            const input = document.getElementById('base-name-input');
            const baseName = input.value.trim();

            if (!baseName) {
                alert('„Åä„Å™„Åæ„Åà„Çí„ÅÑ„Çå„Å¶„Å≠ÔºÅ');
                return;
            }

            // Check if Hiragana only
            if (!/^[„ÅÅ-„Çì„Éº]+$/.test(baseName)) {
                alert('„Å≤„Çâ„Åå„Å™„Åß„ÅÑ„Çå„Å¶„Å≠‚ú®');
                return;
            }

            // Name suggestion logic
            const suffixes = ['„Çä„Çì', '„Å£„Å°', '„ÇÇ„Åæ', '„Å¥', '„Å°„ÇÉ„Çì', '„Åü„Çì', '„Å´„ÇÉ„Çì', '„ÅΩ„Çà'];
            currentSuggestion = baseName + suffixes[Math.floor(Math.random() * suffixes.length)];

            document.getElementById('suggestion-text').innerText = `„Äå${currentSuggestion}„Äç„ÅØ„Å©„ÅÜ„ÇÇ„ÅæÔºü`;

            // Transition: Close Name Modal (via history replacement or back+push?)
            // If we just open suggestion on top, we create a stack: [Name, Suggestion].
            // Back -> Name. This is good.
            openModal('suggestion-modal');
            // But we might want 'Name' to close visually?
            // If we leave it open underneath, it's fine.
            // If we want to replace:
            // history.replaceState(..., suggestion);
            // Let's stick to stacking for "Back" support.
            _internalCloseModal('name-modal'); // Hide previous one visually to avoid clutter
        }

        function saveNickname() {
            userNickname = currentSuggestion;
            localStorage.setItem('moma_user_nickname', userNickname);
            closeModal('suggestion-modal');
            showBubble(`${userNickname}„ÄÅ„Çà„Çç„Åó„Åè„ÇÇ„ÅæÔºÅüíï`);

            moma.classList.add('animate-bounce');
            setTimeout(() => moma.classList.remove('animate-bounce'), 1000);
        }

        function resetNickname() {
            if (confirm('„Åä„Å™„Åæ„Åà„ÇíÊ∂à„Åó„Å°„ÇÉ„ÅÜ„ÇÇ„ÅæÔºü')) {
                userNickname = '';
                localStorage.removeItem('moma_user_nickname');
                closeModal('settings-modal');
                showBubble('„Åä„Å™„Åæ„Åà„ÄÅ„Çè„Åô„Çå„Å°„ÇÉ„Å£„Åü„ÇÇ„Åæ...üíß');
            }
        }

        // --- Birthdate & Biorhythm Logic ---
        function animateButtonSuccess(btn, originalText) {
            if (!btn) return;
            const originalColor = btn.style.backgroundColor;
            btn.innerText = "‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ‚ú®";
            btn.style.backgroundColor = "#98FB98"; // Pastel Green
            btn.style.borderColor = "#98FB98";
            btn.disabled = true;

            // Play a little sound if possible
            playNote();

            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = originalColor;
                btn.style.borderColor = ""; // Reset
                btn.disabled = false;
            }, 1500);
        }

        let userBirthdate = localStorage.getItem('moma_user_birthdate') || '';

        function loadBirthdate() {
            if (userBirthdate) {
                document.getElementById('birthdate-input').value = userBirthdate;
            }
        }

        function saveBirthdate(btnElement) {
            const input = document.getElementById('birthdate-input').value;
            if (input) {
                userBirthdate = input;
                localStorage.setItem('moma_user_birthdate', userBirthdate);
                showBubble("„ÅäË™ïÁîüÊó•„Çí„Åä„Åº„Åà„Åü„ÇÇ„ÅæÔºÅüéÇ");

                // Visual Feedback
                const btn = btnElement || document.querySelector('#settings-modal .btn-confirm:last-of-type');
                animateButtonSuccess(btn, "‰øùÂ≠ò„Åô„Çã");
            } else {
                localStorage.removeItem('moma_user_birthdate');
                userBirthdate = '';
                showBubble("„ÅäË™ïÁîüÊó•„Çí„Çè„Åô„Çå„Åü„ÇÇ„Åæ...");
            }
        }

        function openBiorhythm() {
            if (!userBirthdate) {
                alert("ÂÖà„Å´„ÅäË™ïÁîüÊó•„ÇíÊïô„Åà„Å¶„Å≠ÔºÅ");
                return;
            }
            openModal('biorhythm-modal');
            drawBiorhythmGraph();
            showBiorhythmMessage();
        }

        function calculateBiorhythm(date, birthDateObj) {
            const diffTime = date.getTime() - birthDateObj.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            return {
                physical: Math.sin(2 * Math.PI * diffDays / 23),
                emotional: Math.sin(2 * Math.PI * diffDays / 28),
                intellectual: Math.sin(2 * Math.PI * diffDays / 33)
            };
        }

        function drawBiorhythmGraph() {
            if (!userBirthdate) return;
            const birth = new Date(userBirthdate);
            const today = new Date();

            // Draw range: -7 days to +7 days
            const pointsP = [];
            const pointsE = [];
            const pointsI = [];

            const width = 300;
            const height = 150;
            const totalDays = 14;
            const pixelsPerDay = width / totalDays;

            for (let i = 0; i <= totalDays; i++) {
                const dayOffset = i - 7; // 0 is -7 days, 7 is today, 14 is +7 days
                const targetDate = new Date(today);
                targetDate.setDate(today.getDate() + dayOffset);

                const bio = calculateBiorhythm(targetDate, birth);

                const x = i * pixelsPerDay;
                // y = 0 is top, height is bottom. Center is height/2. 
                // Value 1 -> Top (0), Value -1 -> Bottom (height)
                // Map [-1, 1] to [height, 0]
                const yP = (height / 2) - (bio.physical * (height / 2 - 10));
                const yE = (height / 2) - (bio.emotional * (height / 2 - 10));
                const yI = (height / 2) - (bio.intellectual * (height / 2 - 10));

                pointsP.push(`${x},${yP}`);
                pointsE.push(`${x},${yE}`);
                pointsI.push(`${x},${yI}`);
            }

            document.getElementById('bio-physical').setAttribute('d', `M ${pointsP.join(' L ')}`);
            document.getElementById('bio-emotional').setAttribute('d', `M ${pointsE.join(' L ')}`);
            document.getElementById('bio-intellectual').setAttribute('d', `M ${pointsI.join(' L ')}`);
        }

        function showBiorhythmMessage() {
            if (!userBirthdate) return;
            const birth = new Date(userBirthdate);
            const today = new Date();
            const bio = calculateBiorhythm(today, birth);

            let msg = "";
            let avg = (bio.physical + bio.emotional + bio.intellectual) / 3;

            if (avg > 0.5) {
                msg = "‰ªäÊó•„ÅØÁµ∂Â•ΩË™ø„ÇÇ„ÅæÔºÅÊñ∞„Åó„ÅÑ„Åì„Å®„Å´ÊåëÊà¶„Åô„Çã„ÉÅ„É£„É≥„Çπ„Åã„ÇÇ‚ú®";
            } else if (avg < -0.5) {
                msg = "‰ªäÊó•„ÅØ„É†„É™„Åõ„Åö„ÄÅ„ÇÜ„Å£„Åè„Çä‰ºë„ÇÄ„ÅÆ„Åå„ÅÑ„ÅÑ„ÇÇ„Åæüçµ";
            } else {
                // Check individual highs/lows
                if (bio.physical < -0.6) msg = "‰Ωì„ÅåÂ∞ë„Åó„ÅäÁñ≤„Çå„Åã„ÇÇÔºü„ÅäÈ¢®ÂëÇ„Åß„É™„É©„ÉÉ„ÇØ„Çπ„ÇÇ„Åæ‚ô®Ô∏è";
                else if (bio.emotional < -0.6) msg = "Ê∞óÂàÜËª¢Êèõ„ÅåÂøÖË¶Å„Åã„ÇÇ„ÄÇÂ•Ω„Åç„Å™Èü≥Ê•Ω„ÇíËÅ¥„Åè„ÇÇ„Åæüéµ";
                else if (bio.intellectual > 0.6) msg = "ÂÜ¥„Åà„Å¶„Çã„ÇÇ„ÅæÔºÅÂãâÂº∑„ÇÑ‰ªï‰∫ã„Åå„ÅØ„Åã„Å©„Çä„Åù„ÅÜ‚ú®";
                else msg = "„ÅÑ„Å§„ÇÇÈÄö„Çä„ÅÆÁ©è„ÇÑ„Åã„Å™‰∏ÄÊó•„Å´„Å™„Çä„Åù„ÅÜ„ÇÇ„Åæüêæ";
            }

            document.getElementById('bio-message').innerText = msg;
        }

        function getZodiacSign(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();

            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return { name: "„Åä„Å≤„Å§„ÅòÂ∫ß", element: "Fire" };
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return { name: "„Åä„ÅÜ„ÅóÂ∫ß", element: "Earth" };
            if ((month == 5 && day >= 21) || (month == 6 && day <= 21)) return { name: "„Åµ„Åü„ÅîÂ∫ß", element: "Air" };
            if ((month == 6 && day >= 22) || (month == 7 && day <= 22)) return { name: "„Åã„Å´Â∫ß", element: "Water" };
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return { name: "„Åó„ÅóÂ∫ß", element: "Fire" };
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return { name: "„Åä„Å®„ÇÅÂ∫ß", element: "Earth" };
            if ((month == 9 && day >= 23) || (month == 10 && day <= 23)) return { name: "„Å¶„Çì„Å≥„ÇìÂ∫ß", element: "Air" };
            if ((month == 10 && day >= 24) || (month == 11 && day <= 22)) return { name: "„Åï„Åù„ÇäÂ∫ß", element: "Water" };
            if ((month == 11 && day >= 23) || (month == 12 && day <= 21)) return { name: "„ÅÑ„Å¶Â∫ß", element: "Fire" };
            if ((month == 12 && day >= 22) || (month == 1 && day <= 19)) return { name: "„ÇÑ„ÅéÂ∫ß", element: "Earth" };
            if ((month == 1 && day >= 20) || (month == 2 && day <= 18)) return { name: "„Åø„Åö„Åå„ÇÅÂ∫ß", element: "Air" };
            return { name: "„ÅÜ„ÅäÂ∫ß", element: "Water" };
        }

        const luckyColors = {
            0: ["„Ç¥„Éº„É´„Éâ", "„Ç™„É¨„É≥„Ç∏", "„Éõ„ÉØ„Ç§„Éà"], // Sun (Sunday)
            1: ["„Ç∑„É´„Éê„Éº", "„Éõ„ÉØ„Ç§„Éà", "„Éë„Éº„É´"], // Moon (Monday)
            2: ["„É¨„ÉÉ„Éâ", "„Çπ„Ç´„Éº„É¨„ÉÉ„Éà", "„Éû„Çº„É≥„Çø"], // Mars (Tuesday)
            3: ["„Ç§„Ç®„É≠„Éº", "„É©„Ç§„Éà„Éñ„É´„Éº", "„Éç„Ç§„Éì„Éº"], // Mercury (Wednesday)
            4: ["„Éë„Éº„Éó„É´", "„Ç∞„É™„Éº„É≥", "„É≠„Ç§„É§„É´„Éñ„É´„Éº"], // Jupiter (Thursday)
            5: ["„Éî„É≥„ÇØ", "„Éë„Çπ„ÉÜ„É´„Ç∞„É™„Éº„É≥", "„ÇØ„É™„Éº„É†"], // Venus (Friday)
            6: ["„Éñ„É©„ÉÉ„ÇØ", "„Éñ„É©„Ç¶„É≥", "„Ç∞„É¨„Éº"] // Saturn (Saturday)
        };

        const luckyItems = {
            "Fire": ["„Çπ„Éã„Éº„Ç´„Éº", "„Çµ„É≥„Ç∞„É©„Çπ", "„Ç≠„É£„É≥„Éâ„É´", "Ëµ§„ÅÑÂ∞èÁâ©", "„Çπ„Éù„Éº„ÉÑ„Ç¶„Çß„Ç¢"],
            "Earth": ["Ë¶≥ËëâÊ§çÁâ©", "„Éà„Éº„Éà„Éê„ÉÉ„Ç∞", "Â∞èË™¨", "„Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØÁü≥Èπ∏", "Èô∂Âô®„ÅÆ„Éû„Ç∞"],
            "Air": ["„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥", "‰∏áÂπ¥Á≠Ü", "ÁæΩÊ†π„É¢„ÉÅ„Éº„Éï", "È¶ôÊ∞¥", "ÊúÄÊñ∞„Ç¨„Ç∏„Çß„ÉÉ„Éà"],
            "Water": ["„Éê„Çπ„ÇΩ„É´„Éà", "„Ç¢„ÇØ„Ç¢„É™„Ç¶„É†", "ÁúüÁè†„ÅÆ„Ç¢„ÇØ„Çª", "„Ç¨„É©„ÇπË£ΩÂìÅ", "„Éü„Éç„É©„É´„Ç¶„Ç©„Éº„Çø„Éº"]
        };

        function getMoonPhase(date) {
            // Simple calculation based on known new moon (Jan 6 2000)
            const knownNewMoon = new Date('2000-01-06 18:14:00');
            const diffTime = date.getTime() - knownNewMoon.getTime();
            const diffDays = diffTime / (1000 * 3600 * 24);
            const cycle = 29.53058867;
            const age = diffDays % cycle;

            if (age < 1.5 || age > 28) return { phase: "New Moon", name: "Êñ∞Êúà" };
            if (age > 13.5 && age < 16.5) return { phase: "Full Moon", name: "Ê∫ÄÊúà" };
            return { phase: "Normal", name: "" };
        }

        function getLifePathNumber(birthDateStr) {
            const digits = birthDateStr.replace(/-/g, '').split('').map(Number);
            let sum = digits.reduce((a, b) => a + b, 0);
            while (sum > 9 && sum !== 11 && sum !== 22 && sum !== 33) {
                const sumDigits = String(sum).split('').map(Number);
                sum = sumDigits.reduce((a, b) => a + b, 0);
            }
            return sum;
        }

        function getDailyFortune() {
            if (!userBirthdate) return "„Åæ„Åö„ÅØ„Äå„Åõ„Å£„Å¶„ÅÑ„Äç„Åã„Çâ„ÅäË™ïÁîüÊó•„ÇíÊïô„Åà„Å¶„Åª„Åó„ÅÑ„ÇÇ„ÅæÔºÅüéÇ";

            const today = new Date();
            const birthDate = new Date(userBirthdate);
            const zodiac = getZodiacSign(birthDate);

            // 1. Basic Score
            const dateStr = today.getFullYear() + '' + (today.getMonth() + 1) + '' + today.getDate();
            const birthStr = userBirthdate.replace(/-/g, '');
            let seed = parseInt(dateStr) + parseInt(birthStr);
            seed = Math.sin(seed) * 10000;
            const score = Math.floor((seed - Math.floor(seed)) * 101); // 0-100

            // 2. Lucky Color (Planet/Day based)
            const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon...
            const colorOptions = luckyColors[dayOfWeek];
            const colorIndex = Math.floor((seed - Math.floor(seed)) * 100) % colorOptions.length;
            const color = colorOptions[colorIndex];

            // 3. Lucky Item (Element based)
            const itemOptions = luckyItems[zodiac.element];
            const itemIndex = Math.floor((seed - Math.floor(seed)) * 200) % itemOptions.length;
            const item = itemOptions[itemIndex];

            // 4. Moon Phase Advice
            const moon = getMoonPhase(today);
            let moonMsg = "";
            if (moon.phase === "New Moon") moonMsg = "\nüåë „ÄêÊñ∞Êúà„Äë‰ªäÊó•„ÅØ‰Ωï„Åã„ÇíÂßã„ÇÅ„Çã„ÅÆ„Å´ÊúÄÈÅ©„Å™Êó•„ÇÇ„ÅæÔºÅÈ°ò„ÅÑ‰∫ã„ÇíÊõ∏„ÅÑ„Å¶„Åø„Å¶‚ú®";
            if (moon.phase === "Full Moon") moonMsg = "\nüåï „ÄêÊ∫ÄÊúà„ÄëÊâãÊîæ„Åô„Éë„ÉØ„Éº„ÅåÂº∑„ÅÑÊó•„ÇÇ„Åæ„ÄÇ„ÅäÊéÉÈô§„ÇÑ„Éá„Éà„ÉÉ„ÇØ„Çπ„ÅåÂêâÔºÅüßπ";

            // 5. Life Path Number (One-point advice type)
            const lifePath = getLifePathNumber(userBirthdate);
            let numMsg = "";
            if ([1, 8, 11, 22].includes(lifePath)) numMsg = "Ôºà„É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„Éó„ÇíÁô∫ÊèÆ„Åô„Çã„Å®ÂêâüëëÔºâ";
            else if ([2, 6, 9, 33].includes(lifePath)) numMsg = "Ôºà‰∫∫„Å´ÂÑ™„Åó„Åè„Åô„Çã„Å®ÈÅãÊ∞ó„Ç¢„ÉÉ„ÉóüíñÔºâ";
            else if ([3, 5].includes(lifePath)) numMsg = "ÔºàÊ•Ω„Åó„ÇÄÂøÉ„ÇíÂ§ßÂàá„Å´„Åô„Çã„Å®ÂêâüéâÔºâ";
            else numMsg = "Ôºà„Ç≥„ÉÑ„Ç≥„ÉÑÂä™Âäõ„ÅåÂÆü„ÇíÁµê„Å∂„ÇÇ„Åæüê¢Ôºâ"; // 4, 7

            // 6. Advice based on Element and Score
            let advice = "";
            const isHigh = score >= 70;
            const isLow = score <= 30;

            if (zodiac.element === "Fire") {
                if (isHigh) advice = "ÊÉÖÁÜ±ÁöÑ„Å´Ë°åÂãï„Åô„Çã„Å®Âêâ„ÇÇ„ÅæÔºÅÊñ∞„Åó„ÅÑ„Åì„Å®„Å´ÊåëÊà¶„Åó„Å¶„Åø„Å¶üî•";
                else if (isLow) advice = "‰ªäÊó•„ÅØÂ∞ë„ÅóÂÜ∑Èùô„Å´„ÄÇÊ∑±ÂëºÂê∏„Åó„Å¶„É™„É©„ÉÉ„ÇØ„Çπ„Åô„Çã„ÇÇ„Åæüòå";
                else advice = "Êòé„Çã„ÅÑÁ¨ëÈ°î„ÅåÈÅãÊ∞ó„ÇíÂëº„Å∂„ÇÇ„ÅæÔºÅÂë®„Çä„ÅÆ‰∫∫„ÇíÂÖÉÊ∞ó„Å´„Åó„Å¶„Åø„Å¶‚ú®";
            } else if (zodiac.element === "Earth") {
                if (isHigh) advice = "„Ç≥„ÉÑ„Ç≥„ÉÑÁ©ç„ÅøÈáç„Å≠„Åü„Åì„Å®„ÅåÂÆü„ÇíÁµê„Å∂Êó•„ÇÇ„ÅæÔºÅËá™‰ø°„ÇíÊåÅ„Å£„Å¶üå±";
                else if (isLow) advice = "ÁÑ¶„Çä„ÅØÁ¶ÅÁâ©„ÇÇ„Åæ„ÄÇÁæéÂë≥„Åó„ÅÑ„ÇÇ„ÅÆ„ÇíÈ£ü„Åπ„Å¶Âú∞„Å´Ë∂≥„Çí„Å§„Åë„Çã„ÇÇ„Åæüç†";
                else advice = "Êï¥ÁêÜÊï¥È†ì„Åå„É©„ÉÉ„Ç≠„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇÇ„ÅæÔºÅ„Çπ„ÉÉ„Ç≠„É™„Åô„Çã„Å®ËâØ„ÅÑ„Åì„Å®„ÅÇ„Çã„Åã„ÇÇ‚ú®";
            } else if (zodiac.element === "Air") {
                if (isHigh) advice = "„Ç¢„Ç§„Éá„Ç¢„Åå„Å©„Çì„Å©„ÇìÊπß„ÅÑ„Å¶„Åè„ÇãÊó•„ÇÇ„ÅæÔºÅÂèãÈÅî„Å®„Ç∑„Çß„Ç¢„Åó„Å¶„Åø„Å¶‚òÅÔ∏è";
                else if (isLow) advice = "ÊÉÖÂ†±ÈÅéÂ§ö„ÅßÁñ≤„Çå„Å°„ÇÉ„ÅÜ„Åã„ÇÇÔºü„Çπ„Éû„Éõ„ÇíÁΩÆ„ÅÑ„Å¶„Éá„Ç∏„Çø„É´„Éá„Éà„ÉÉ„ÇØ„Çπ„ÇÇ„Åæüìµ";
                else advice = "Êñ∞„Åó„ÅÑÈ¢®„ÇíÊÑü„Åò„ÇãÂ†¥ÊâÄ„Å∏Ë°å„Åè„Å®Âêâ„ÇÇ„ÅæÔºÅÁ™ì„ÇíÈñã„Åë„Å¶ÊèõÊ∞ó„ÇÇ„Åä„Åô„Åô„ÇÅ‚ú®";
            } else if (zodiac.element === "Water") {
                if (isHigh) advice = "Áõ¥ÊÑü„ÅåÂÜ¥„ÅàÊ∏°„ÇãÊó•„ÇÇ„ÅæÔºÅËá™ÂàÜ„ÅÆÊ∞óÊåÅ„Å°„Å´Ê≠£Áõ¥„Å´Âãï„ÅÑ„Å¶„Åø„Å¶üíß";
                else if (isLow) advice = "ÊÑüÊÉÖ„ÅåÊè∫„Çå„ÇÑ„Åô„ÅÑ„Åã„ÇÇ„ÄÇÂ•Ω„Åç„Å™Èü≥Ê•Ω„ÇíËÅ¥„ÅÑ„Å¶ÂøÉ„ÇíËêΩ„Å°ÁùÄ„Åë„Çã„ÇÇ„Åæüéµ";
                else advice = "‰∫∫„Å∏„ÅÆÂÑ™„Åó„Åï„ÅåÂ∑°„ÇäÂ∑°„Å£„Å¶Ëá™ÂàÜ„Å´Ëøî„Å£„Å¶„Åè„Çã„ÇÇ„Åæ„ÄÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Çí‰ºù„Åà„Å¶„Åø„Å¶üíï";
            }

            return `„Äê${zodiac.name}„Äë„ÅÆ‰ªäÊó•„ÅÆÈÅãÂã¢„ÅØ...\nüéâ ${score}ÁÇπ üéâ\n\nüé® „É©„ÉÉ„Ç≠„Éº„Ç´„É©„Éº: ${color}\n‚ú® „É©„ÉÉ„Ç≠„Éº„Ç¢„Ç§„ÉÜ„É†: ${item}\n\nüí° „Ç¢„Éâ„Éê„Ç§„Çπ:\n${advice}\n${moonMsg}\n\nüî¢ ÈÅãÂëΩÊï∞${lifePath}${numMsg}`;
        }

        // --- Chat Functions ---
        const topicMenu = document.getElementById('topic-menu');
        const menuTopics = document.getElementById('menu-topics');
        const menuInput = document.getElementById('menu-input');
        const menuInstruction = document.getElementById('menu-instruction');
        const momaBubble = document.getElementById('moma-bubble');
        const userInput = document.getElementById('user-input');

        let currentTopic = '';

        function openChat() {
            if (state === 'SLEEPING') return;
            history.pushState({ ui: 'menu' }, '', '#chat');
            _internalOpenChat();
        }

        function _internalOpenChat() {
            showTopics();
            topicMenu.style.display = 'flex';
        }

        function showTopics() {
            currentTopic = '';
            menuTopics.style.display = 'flex';
            menuInput.style.display = 'none';
            menuInstruction.innerText = '„Å©„ÅÆ„Åä„ÅØ„Å™„Åó„Å´„Åô„ÇãÔºü';
            userInput.value = '';
        }

        const mealSuggestions = [
            { text: 'ÂêâÈáéÂÆ∂„ÅÆÁâõ‰∏º„ÄÅ„Å§„ÇÜ„Å†„Åè„Å´„Åô„Çã„ÇÇ„ÅæÔºü', weight: 1 },
            { text: '„ÇÇ„Åæ„Å°„ÇÉ„Çì„ÅØ„Éû„ÇØ„Éâ„Éä„É´„Éâ„ÅÆ„Éù„ÉÜ„Éà„ÅåÈ£ü„Åπ„Åü„ÅÑ„ÇÇ„ÅæÔΩûüçü', weight: 1 },
            { text: '„É≠„ÉÉ„ÉÜ„É™„Ç¢„ÅÆÁµ∂ÂìÅ„ÉÅ„Éº„Ç∫„Éê„Éº„Ç¨„Éº„ÄÅÊ∞ó„Å´„Å™„Çã„ÇÇ„ÅæÔºÅ', weight: 1 },
            { text: '„Åä„Åì„ÅÆ„Åø„ÇÑ„ÅçÈÅì„Å®„ÇìÂ†Ä„Åß„ÄÅ„ÅΩ„Çì„ÅΩ„Åì„ÅΩ„Çì„ÇÇ„ÅæÔºÅü¶ù', weight: 1 },
            { text: '„Å≥„Å£„Åè„Çä„Éâ„É≥„Ç≠„Éº„ÅÆ„Éè„É≥„Éê„Éº„Ç∞„Å´„Åô„Çã„ÇÇ„ÅæÔºü', weight: 1 },
            { text: '‰∏∏‰∫ÄË£ΩÈ∫∫„Åß„ÅÜ„Å©„Çì„Å§„Çã„Å§„Çã„Åó„Åü„ÅÑ„ÇÇ„Åæ„Å≠„Åá‚ú®', weight: 1 },
            { text: '„Çµ„Ç§„Çº„É™„É§„ÅÆ„Éü„É©„ÉéÈ¢®„Éâ„É™„Ç¢„ÅØÈâÑÊùø„ÇÇ„ÅæÔºÅ', weight: 1 },
            { text: '„Çπ„Ç∑„É≠„Éº„Åß10Áöø„Åü„Åπ„Çã„ÇÇ„ÅæÔΩûüç£', weight: 1 },
            { text: '„Åè„ÇâÂØøÂè∏„Åß„Å≥„Å£„Åè„Çâ„Éù„É≥ÂΩì„Å¶„Çã„ÇÇ„ÅæÔºÅüéØ', weight: 1 },
            { text: '‰ªäÊó•„ÅØ„Ç´„É¨„Éº„Éè„Ç¶„ÇπCoCoÂ£±Áï™Â±ã„Å´„Åó„Å°„ÇÉ„ÅÜ„ÇÇ„ÅæÔºü Curry! Curry!', weight: 1 },
            { text: 'È§ÉÂ≠ê„ÅÆÁéãÂ∞Ü„Åß„ÇÆ„Éß„Éº„Ç∂„Å±„Åè„Å±„Åè„Åô„Çã„ÇÇ„ÅæÔºÅü•ü', weight: 1 },
            { text: 'Â§ßÈò™ÁéãÂ∞Ü„ÅÆ„Åµ„Çè„Å®„ÇçÂ§©Ê¥•È£Ø„ÇÇÊç®„Å¶„Åå„Åü„ÅÑ„ÇÇ„Åæ...', weight: 1 },
            { text: '„É¢„Çπ„Éê„Éº„Ç¨„Éº„ÅÆ„ÉÜ„É™„É§„Ç≠„ÄÅ„É¨„Çø„Çπ„Åó„ÇÉ„Åç„Åó„ÇÉ„Åç„ÇÇ„Åæ„ÇàÔΩû', weight: 1 },
            { text: '„Å™„ÅãÂçØ„ÅÆË¶™Â≠ê‰∏º„ÄÅ„Åµ„Çè„Å®„Çç„ÇÇ„Åæ„Å≠„Åá', weight: 1 },
            { text: 'Â§©‰∏ã‰∏ÄÂìÅ„ÅÆ„Åì„Å£„Å¶„Çä„É©„Éº„É°„É≥„ÄÅ„Åü„Åæ„Å´È£ü„Åπ„Åü„Åè„Å™„Çã„ÇÇ„ÅæÔºÅ', weight: 1 },
            { text: '„Ç±„É≥„Çø„ÉÉ„Ç≠„Éº„ÅÆ„Ç™„É™„Ç∏„Éä„É´„ÉÅ„Ç≠„É≥„ÄÅ„Çπ„Éë„Ç§„Çπ„Åç„ÅÑ„Å¶„Çã„ÇÇ„ÅæÔºÅüçó', weight: 1 },
            { text: 'ÊùæÂ±ã„ÅÆÁâõ„ÇÅ„Åó„ÄÅÂë≥ÂôåÊ±Å„Åå„Å§„ÅÑ„Å¶„Åç„Å¶Â¨â„Åó„ÅÑ„ÇÇ„ÅæÔºÅ', weight: 1 },
            { text: '„Åô„ÅçÂÆ∂„ÅÆ3Á®Æ„ÅÆ„ÉÅ„Éº„Ç∫Áâõ‰∏º„ÄÅ„Å®„Çç„Å®„Çç„ÇÇ„ÅæÔΩûüßÄ', weight: 1 },
            { text: '„Ç¨„Çπ„Éà„ÅÆ„ÉÅ„Éº„Ç∫IN„Éè„É≥„Éê„Éº„Ç∞„ÄÅÂàá„Çã„Å®„Åò„ÇÖ„ÇèÔΩû„ÇÇ„ÅæÔºÅ', weight: 1 },
            { text: 'ÂØåÂ£´„Åù„Å∞„Åß„Çµ„ÇØ„ÉÉ„Å®„Åä„Åù„Å∞È£ü„Åπ„Çã„ÇÇ„ÅæÔºü', weight: 1 },
            { text: 'ÁÑºËÇâ„Åç„Çì„Åê„ÅßÈ£ü„ÅπÊîæÈ°åÔºÅ„Åä„Å™„Åã„ÅΩ„Çì„ÅΩ„Çì„ÇÇ„ÅæÔºÅ', weight: 1 },
            { text: 'Â§ßÊà∏Â±ã„ÅÆ„Åó„Åæ„Åª„Å£„ÅëÂÆöÈ£ü„ÄÅÂÅ•Â∫∑ÁöÑ„ÇÇ„Åæ„Å≠„Åá', weight: 1 },
            { text: '„ÇÑ„Çà„ÅÑËªí„Åß„Åä„Åã„Çè„ÇäÁÑ°Èôê„É´„Éº„Éó„ÇÇ„Åæ...ÔºÅüçö', weight: 1 },
            { text: '„ÅØ„Å™„Åæ„Çã„ÅÜ„Å©„Çì„ÅÆÊ∏©Áéâ„Å∂„Å£„Åã„Åë„ÄÅ„Å§„Çã„Å§„Çã„ÇÇ„ÅæÔΩû', weight: 1 },
            { text: 'ÁØâÂú∞ÈäÄ„Å†„Åì„ÅÆ„Åü„ÅìÁÑº„Åç„ÄÅÂ§ñ„Ç´„É™‰∏≠„Éà„É≠„ÇÇ„Åæ„ÇàÔºÅüêô', weight: 1 },
            { text: '„Çµ„Éº„ÉÜ„Ç£„ÉØ„É≥„ÅÆ„Éù„ÉÉ„Éî„É≥„Ç∞„Ç∑„É£„ÉØ„ÉºÔºÅ„Éë„ÉÅ„Éë„ÉÅ„ÇÇ„ÅæÔºÅüç®', weight: 1 },
            { text: '‰∏ÄËò≠„ÅßÈõÜ‰∏≠„Åó„Å¶„É©„Éº„É°„É≥„Åü„Åπ„Çã„ÇÇ„Åæ...üçú', weight: 1 },
            { text: 'ÁâõËßí„ÅßÁ∂≤ÁÑº„Åç„Éë„Éº„ÉÜ„Ç£„ÇÇ„ÅæÔºÅ„Åò„ÇÖ„Éº„Åò„ÇÖ„ÉºÔºÅüî•', weight: 1 },
            { text: '„Å§„Çã„Å®„Çì„Åü„Çì„ÅÆÂ§ß„Åç„Å™Âô®„ÄÅ„Å≥„Å£„Åè„Çä„Åô„Çã„ÇÇ„Åæ„Å≠', weight: 1 },
            { text: '„Éü„Çπ„Çø„Éº„Éâ„Éº„Éä„ÉÑ„Åß„Éù„É≥„Éª„Éá„Éª„É™„É≥„Ç∞10ÂÄã„Åü„Åπ„Çã„ÇÇ„ÅæÔºÅüç©', weight: 1 },
            { text: '„Ç≥„É°„ÉÄÁèàÁê≤Â∫ó„Åß„Ç∑„É≠„Éé„ÉØ„Éº„É´È£ü„Åπ„Çã„ÇÇ„ÅæÔºüüêå', weight: 1 },
            { text: '„Çπ„Çø„Éº„Éê„ÉÉ„ÇØ„Çπ„ÅßÊñ∞‰Ωú„Éï„É©„Éö„ÉÅ„Éº„Éé„ÇÇ„ÅæÔºÅü•§', weight: 1 },
            { text: '„Çµ„Éñ„Ç¶„Çß„Ç§„Åß„ÅäÈáéËèú„Åü„Å£„Å∑„Çä„ÅÆ„Çµ„É≥„Éâ„Ç§„ÉÉ„ÉÅ„Å´„Åô„Çã„ÇÇ„ÅæÔºüü•™', weight: 1 },
            { text: 'Êòü‰πÉÁèàÁê≤Â∫ó„ÅÆ„Åµ„Çè„Åµ„Çè„Çπ„Éï„É¨„Éë„É≥„Ç±„Éº„Ç≠„ÄÅÈ£ü„Åπ„Åü„ÅÑ„ÇÇ„ÅæÔΩûü•û', weight: 1 },
            { text: '‰ªäÊó•„ÅØÂ•ÆÁô∫„Åó„Å¶„ÄÅ„ÅÜ„Å™„Åé„ÅÆËí≤ÁÑº„Å´„Åó„Å°„ÇÉ„ÅÜ„ÇÇ„ÅæÔºüüêç', weight: 1 },
            { text: '„Ç≥„Ç≥„Çπ„ÅßÂåÖ„ÅøÁÑº„Åç„Éè„É≥„Éê„Éº„Ç∞„ÇÇ„ÅæÔºÅ„ÅÇ„Å§„ÅÇ„Å§ÔºÅ', weight: 1 },
            { text: '‰∏ÄÈ¢®Â†Ç„ÅÆÁôΩ‰∏∏„ÉªËµ§‰∏∏„ÄÅ„Å©„Å£„Å°„Å´„Åô„Çã„ÇÇ„ÅæÔºüüçú', weight: 1 },
            { text: '„Éï„É¨„ÉÉ„Ç∑„É•„Éç„Çπ„Éê„Éº„Ç¨„Éº„ÅÆ„ÇØ„É©„Ç∑„ÉÉ„ÇØ„Éê„Éº„Ç¨„Éº„ÇÇ„ÅæÔºÅüçî', weight: 1 },
            { text: '„Ç∏„Éß„Éä„Çµ„É≥„ÅÆ„É¢„Éº„Éã„É≥„Ç∞„ÅßÂÑ™ÈõÖ„Å™Êúù„ÇÇ„Åæ...‚òï', weight: 1 },
            { text: '„Å¶„Çì„ÇÑ„ÅÆÂ§©‰∏º„ÄÅ„Çø„É¨„Åå„Åü„Åæ„Çâ„Å™„ÅÑ„ÇÇ„Åæ„Å≠„Åáüç§', weight: 1 },
            { text: '‰ªäÊó•„ÅØËá™ÁÇäÔºÅÂ°©„ÇÄ„Åô„Å≥„Çí„ÇÄ„Åô„Çì„Åß„ÅÇ„Åí„Çã„ÇÇ„Åæüçô', weight: 1 },
            { text: '„Åª„Åã„Åª„Åã„ÅÆ„ÅäÂë≥ÂôåÊ±Å„Å®ÁôΩÁ±≥„ÄÅ‰∏ÄÁï™„ÅÆ„Åî„Å°„Åù„ÅÜ„ÇÇ„ÅæÔºÅüçö', weight: 1 },
            { text: '„ÇÇ„Åæ„Å°„ÇÉ„Çì„ÅÆÁâπË£Ω„Ç™„É†„É©„Ç§„Çπ...„ÅÇ„ÄÅËá™ÁÇä„ÇÇÂøúÊè¥„Åô„Çã„ÇÇ„ÅæÔºÅüê£', weight: 1 }
        ];

        const scaryStories = [
            { text: 'Â§ú‰∏≠„Å´ÁõÆ„ÅåË¶ö„ÇÅ„Åü„Çâ„ÄÅ„Åä„ÇÑ„Å§„ÅÆ„Éó„É™„É≥„ÅåÂÖ®ÈÉ®„Å™„Åè„Å™„Å£„Å¶„Åü„ÇÇ„Åæ...ÔºÅÁäØ‰∫∫„ÅØ...„ÇÇ„Åæ„Å°„ÇÉ„Çì„Å†„Å£„Åü„ÇÇ„ÅæüëªÔºàÈ£ü„Åπ„Åü„ÅÆÂøò„Çå„Å¶„Åü„Å†„Åë„ÇÇ„ÅæÔºâ', weight: 1 },
            { text: 'ÈÉ®Â±ã„ÅÆÈöÖ„Å´Èªí„ÅÑÂΩ±„Åå...! „Å®ÊÄù„Å£„Åü„Çâ„ÄÅ„ÅÇ„Å™„Åü„ÅÆËÑ±„Åé„Å£„Å±„Å™„Åó„ÅÆÈù¥‰∏ã„Å†„Å£„Åü„ÇÇ„Åæ„ÄÇ„Å≥„Å£„Åè„Çä„Åó„Å¶„ÄÅ„Åé„ÇÖ„Éº„Åó„Å°„ÇÉ„Å£„Åü„ÇÇ„Åæ„Çà‚ú®', weight: 1 },
            { text: '„ÅÇ„ÇãÊó•„ÄÅ„ÇÇ„Åæ„Å°„ÇÉ„Çì„ÅåÂëº„Çì„Åß„ÇÇËøî‰∫ã„Åå„Å™„ÅÑ„ÇÇ„Åæ...„ÄÇ„ÇÇ„Åó„Åã„Åó„Å¶Ê∂à„Åà„Å°„ÇÉ„Å£„ÅüÔºÅÔºü„Å®ÊÄù„Å£„Åü„Çâ„ÄÅ„ÇÇ„Åæ„Å°„ÇÉ„Çì„Åå„ÅäÊòºÂØù„Åó„Å¶„Åü„Å†„Åë„Å†„Å£„Åü„ÇÇ„Åæüí§ „Å≥„Å£„Åè„Çä„Åó„Åü„ÇÇ„Åæ„Äú', weight: 1 },
            { text: 'Â§ú„Å´„ÅäÊï£Ê≠©„Åó„Å¶„Åü„Çâ„Äå„ÅÜ„Çâ„ÇÅ„Åó„ÇÑ„Äú„Äç„Å£„Å¶ËÅû„Åì„Åà„Åü„ÇÇ„ÅæÔºÅ„Åß„ÇÇ„Çà„ÅèËÅû„ÅÑ„Åü„Çâ„Äå„ÅÜ„Çâ„ÇÅ„Åó„ÇÖ„ÇÑ„Äú„ÄÅ„Åä„Å™„Åã„ÅåÁ©∫„ÅÑ„Åü„ÇÇ„Åæ...„Äç„Å£„Å¶„ÅäËÖπ„ÅÆÈü≥„Å†„Å£„Åü„ÇÇ„Åæüçô', weight: 1 },
            { text: 'Èè°„ÇíË¶ã„Åü„Çâ„ÄÅ„Åù„Åì„Å´„ÅØËá™ÂàÜ„Åù„Å£„Åè„Çä„ÅÆÂßø„Åå...ÔºÅ„Å£„Å¶„ÄÅ„Åù„Çå„ÅØ„Åü„Å†„ÅÆÈè°„ÇÇ„Åæ„Å≠„ÄÇ„ÇÇ„Åæ„Å°„ÇÉ„Çì„ÄÅ‰ªäÊó•„ÇÇÊúÄÈ´ò„Å´ÂèØÊÑõ„Åã„Å£„Åü„ÇÇ„Åæ„Äúüíï', weight: 1 },
            { text: 'Êöó„ÅÑÂªä‰∏ã„Åã„Çâ„Äå„Ç´„Çµ„Ç´„Çµ...„Äç„Å£„Å¶Èü≥„ÅåÔºÅÂãáÊ∞ó„ÇíÂá∫„Åó„Å¶Ë¶ã„Å´Ë°å„Å£„Åü„Çâ„ÄÅ‰∏∏„Åæ„Å£„Åü„É¨„Ç∑„Éº„Éà„ÅåÈ¢®„Å´Âêπ„Åã„Çå„Å¶„Åü„Å†„Åë„Å†„Å£„Åü„ÇÇ„Åæ„ÄÇÁ¥ô„Åè„Åö„ÇÇÂÖÉÊ∞ó„ÇÇ„Åæ„Å≠„Åá‚ú®', weight: 1 },
            { text: '„Åï„Å£„Åç„Åæ„Åß„ÅÇ„Å£„Åü„ÅØ„Åö„ÅÆ„ÉÅ„Éß„Ç≥„É¨„Éº„Éà„Åå„ÄÅÂøΩÁÑ∂„Å®Ê∂à„Åà„Åü„ÇÇ„Åæ...„ÄÇ„Åì„Çå„ÅØ„ÄÅ„ÅäËèìÂ≠êÊ≥•Ê£í„ÅÆ‰ªïÊ•≠„ÇÇ„ÅæÔºÅ„ÅÇ„ÄÅ„ÇÇ„Åæ„Å°„ÇÉ„Çì„ÅÆÂè£„ÅÆÂë®„Çä„Å´„ÉÅ„Éß„Ç≥„Åå„Å§„ÅÑ„Å¶„Çã...Ôºüüç´', weight: 1 },
            { text: 'Â§ú„ÄÅË™∞„ÇÇ„ÅÑ„Å™„ÅÑ„ÅØ„Åö„ÅÆ„É™„Éì„É≥„Ç∞„Åã„ÇâÁ¨ë„ÅÑÂ£∞„Åå...„ÄÇÊÅê„ÇãÊÅê„ÇãË¶ó„ÅÑ„Åü„Çâ„ÄÅ„ÉÜ„É¨„Éì„ÅÆ„Çø„Ç§„Éû„Éº„Åå„Å§„ÅÑ„Å¶„ÅäÁ¨ë„ÅÑÁï™ÁµÑ„ÅåÊµÅ„Çå„Å¶„Åü„Å†„Åë„Å†„Å£„Åü„ÇÇ„Åæ„ÄÇ„Å≥„Å£„Åè„Çä„Åó„Åü„Åë„Å©Èù¢ÁôΩ„Åã„Å£„Åü„ÇÇ„ÅæÔºÅüì∫', weight: 1 }
        ];

        let mealHistory = [];
        let scaryHistory = [];

        const dreamDictionary = {
            'Ëõá': 'ÈáëÈÅã„ÇÑÂÜçÁîü„ÅÆË±°Âæ¥„ÇÇ„Åæ„ÄÇËâØ„ÅÑÂ§âÂåñ„ÅåËµ∑„Åç„ÇãÂâçËß¶„Çå„Åã„ÇÇ„ÅæÔºÅüêç',
            'Á©∫': 'Ëá™Áî±„Å∏„ÅÆÊÜß„Çå„ÇÑ„ÄÅÂèØËÉΩÊÄß„ÅåÂ∫É„Åå„Å£„Å¶„ÅÑ„Çã„Çµ„Ç§„É≥„ÇÇ„Åæ„ÄÇÈ´ò„ÅèÈ£õ„Å∂„Åª„Å©Áµ∂Â•ΩË™ø„ÇÇ„ÅæÔºÅ‚òÅÔ∏è',
            'ÈÄÉ„Åí„Çã': '‰Ωï„Åã„Åã„Çâ„Éó„É¨„ÉÉ„Ç∑„É£„Éº„ÇíÊÑü„Åò„Å¶„ÅÑ„Çã„ÅÆ„Åã„ÇÇ„Åæ„ÄÇ„Åü„Åæ„Å´„ÅØ„ÇÇ„Åæ„Å°„ÇÉ„Çì„Å®‰ºë„ÇÄ„ÇÇ„Åæ„Çà„ÄÇüèÉ',
            'ËêΩ„Å°„Çã': '‰∏çÂÆâ„ÇÑËá™‰ø°„ÅÆ„Å™„Åï„ÇíË°®„Åó„Å¶„ÅÑ„Çã„ÇÇ„Åæ„ÄÇ„ÇÇ„Åæ„Å°„ÇÉ„Çì„Åå‰∏ã„ÅßÂèó„ÅëÊ≠¢„ÇÅ„Çã„Åã„ÇâÂ§ß‰∏àÂ§´„ÇÇ„ÅæÔºÅüß∏',
            'Áå´': 'Áõ¥ÊÑüÂäõ„ÅåÈ´ò„Åæ„Å£„Å¶„ÅÑ„Çã„Åã„ÄÅË™∞„Åã„Å´Áîò„Åà„Åü„ÅÑÊ∞óÊåÅ„Å°„ÅÆË°®„Çå„ÇÇ„Åæ„ÄÇ„ÇÇ„Åæ„ÇÇÁå´„Å°„ÇÉ„Çì„Å®ÈÅä„Å≥„Åü„ÅÑ„ÇÇ„ÅæÔºÅüêæ'
        };

        function getWeightedRandom(items, history) {
            // 1. Filter items based on history (exclude if in history)
            let candidates = items.map((item, index) => ({ item, index }))
                .filter(c => !history.includes(c.index));

            // 2. Fallback: if all items are in history, clear half of the history
            if (candidates.length === 0 || (items.length > 5 && candidates.length < items.length * 0.3)) {
                history.splice(0, Math.floor(history.length / 2));
                candidates = items.map((item, index) => ({ item, index }))
                    .filter(c => !history.includes(c.index));
            }

            // 3. Select based on weight
            const totalWeight = candidates.reduce((sum, c) => sum + c.item.weight, 0);
            let random = Math.random() * totalWeight;

            for (const c of candidates) {
                if (random < c.item.weight) {
                    history.push(c.index);
                    if (history.length > items.length * 0.7) history.shift();
                    return c.item.text;
                }
                random -= c.item.weight;
            }
            // Fallback to absolute random if something goes wrong
            return candidates[0].item.text;
        }

        function selectTopic(topic, isAuto = false) {
            if (isAuto && topic === '„Å™„Å´È£ü„Åπ„Çà„Å£„ÅãÔΩû') {
                if (history.state && history.state.ui === 'menu') history.back();
                else topicMenu.style.display = 'none';

                const suggestion = getWeightedRandom(mealSuggestions, mealHistory);
                showBubble(suggestion);
                return;
            }

            if (isAuto && topic === '„Åì„Çè„ÅÑ„ÅØ„Å™„Åó„Åó„Å¶') {
                if (history.state && history.state.ui === 'menu') history.back();
                else topicMenu.style.display = 'none';

                const story = getWeightedRandom(scaryStories, scaryHistory);
                showBubble(story);
                return;
            }

            if (isAuto && topic === '‰ªäÊó•„ÅÆÈÅãÂã¢Êïô„Åà„Å¶üîÆ') {
                if (history.state && history.state.ui === 'menu') history.back();
                else topicMenu.style.display = 'none';
                showBubble(getDailyFortune());
                return;
            }

            if (isAuto && topic === '„Éê„Ç§„Ç™„É™„Ç∫„É†Ë¶ã„Åõ„Å¶üìà') {
                if (!userBirthdate) {
                    alert("ÂÖà„Å´„ÅäË™ïÁîüÊó•„ÇíÊïô„Åà„Å¶„Å≠ÔºÅ");
                    return;
                }
                topicMenu.style.display = 'none';
                openBiorhythm();
                return;
            }

            if (isAuto && topic === 'Â§¢Âç†„ÅÑ„Åó„Å¶üåô') {
                currentTopic = topic;
                menuTopics.style.display = 'none';
                menuInput.style.display = 'flex';
                menuInstruction.innerText = "„Å©„Çì„Å™Â§¢„ÇíË¶ã„Åü„Åã„ÇÇ„ÅæÔºü„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÊïô„Åà„Å¶„Å≠‚ú®";
                userInput.placeholder = "‰æãÔºöËõá„ÅåÂá∫„Å¶„Åç„Åü„ÄÅÁ©∫„ÇíÈ£õ„Çì„Å†...„Å™„Å©";
                userInput.focus();
                return;
            }
            currentTopic = topic;
            menuTopics.style.display = 'none';
            menuInput.style.display = 'flex';
            menuInstruction.innerText = `„Äå${topic}„Äç„Å´„Å§„ÅÑ„Å¶„Åä„Åó„Åà„Å¶ÔºÅ`;
            userInput.placeholder = "„Åì„Åì„Å´ÂÖ•Âäõ„Åó„Å¶„Å≠...";
            userInput.focus();
        }

        function closeChat(e) {
            if (history.state && history.state.ui === 'menu') {
                history.back();
            } else {
                topicMenu.style.display = 'none';
            }
        }

        const topicContexts = {
            '„Åä„ÇÑ„Å§': ['„Åä„ÅÑ„Åó„Åù„ÅÜÔºÅ', '„ÇÇ„Åæ„ÇÇ„Åü„Åπ„Åü„ÅÑÔºÅ', '„Åä„ÇÑ„Å§„Çø„Ç§„É†„Å†„Å≠‚ú®'],
            '„Åä„ÅÑ„Åó„ÅÑ„ÇÇ„ÅÆ': ['„Çà„Å†„Çå„Åå„Åß„Å°„ÇÉ„ÅÜ...ü§§', '„ÅÑ„ÅÑ„Å™„ÅÅÔΩûÔºÅ', '„Åì„Çì„Å©„ÅÑ„Å£„Åó„Çá„Å´„Åü„Åπ„ÇàÔºü'],
            '„Åì„Çå„Åô„Åç': ['„Åù„Çå„ÄÅ„ÇÇ„Åæ„ÇÇ„Åô„ÅçÔºÅ', '„Éè„ÉÉ„Éî„Éº„Å´„Å™„Çå„Çã„Å≠‚ú®', '„Åô„Å¶„Åç„Å†„Å≠„Åá üíï'],
            '„Å§„Åæ„Çì„Å™„ÅÑ': ['„Åù„Çì„Å™„Å®„Åç„ÅØ„ÄÅ„Åä„Å©„ÇäÊòé„Åã„Åù„ÅÜÔºÅüï∫', '„ÇÇ„Åæ„ÅåÁ¨ë„Çè„Åõ„Å¶„ÅÇ„Åí„ÇãÔºÅ', '„ÅÆ„Çì„Å≥„Çä„Åó„Çà„Å£„Åãüí§'],
            '„Åü„ÅÆ„ÅóÔΩû': ['„Çè„Éº„ÅÑÔºÅÊúÄÈ´ò„Å†„Å≠ÔºÅ‚ú®', '„ÇÇ„Å£„Å®„ÇÇ„Å£„Å®„Åü„ÅÆ„Åó„ÇÇ„ÅÜÔºÅ', '„Éè„ÉÉ„Éî„Éº„Éè„ÉÉ„Éî„ÉºÔºÅ'],
            '„Åì„Çè„ÅÑ': ['„ÇÇ„Åæ„Åå„Åä„Å∞„Åë„Çí„ÇÑ„Å£„Å§„Åë„ÇãÔºÅ‚öîÔ∏è', 'Â§ß‰∏àÂ§´„ÄÅ„ÅÑ„Å£„Åó„Çá„Å´„ÅÑ„Çã„Çàüíß', '„Åé„ÇÖ„Éº„Å£„Å¶„Åó„Å¶„ÅÇ„Åí„ÇãÔºÅ'],
            '„Åç„ÅÑ„Å¶ÔºÅ': ['„ÅÜ„Çì„ÅÜ„Çì„ÄÅ„Åù„Çå„Åß„Åù„Çå„ÅßÔºüüì¢', '„Å≥„Å£„Åè„Çä„Åó„Å°„ÇÉ„ÅÜ„Å≠ÔºÅ', '„Åô„Åî„ÅÑ„ÅäË©±„Å†ÔΩûÔºÅ‚ú®'],
            '„Åä„Åï„Çì„ÅΩ': ['„Åä„Åï„Çì„ÅΩ„Å†„ÅÑ„Åô„ÅçÔºÅüêæ', '„Å©„Åì„Åæ„Åß„ÅÑ„Åì„ÅÜ„ÅãÔºü', '„Åó„Å£„ÅΩÊåØ„Å£„Å°„ÇÉ„ÅÜ‚ô™'],
            '„Å†„ÅÑ„Åô„Åç': ['„ÇÇ„Åæ„ÇÇ„Åõ„Åã„ÅÑ„ÅÑ„Å°„Å†„ÅÑ„Åô„ÅçÔºÅÔºÅüíï', '„Åö„Å£„Å®„ÅÑ„Å£„Åó„Çá„Å´„ÅÑ„Çà„ÅÜ„Å≠///', '„Å°„ÇÖ„Å£ÔºÅ‚ú®'],
            '„Å™„ÅÑ„Åó„ÇáË©±': ['„ÇÇ„Åæ„ÄÅÂè£„Åã„Åü„ÅÑ„Çàü§´', '„Åµ„ÇÄ„Åµ„ÇÄ...ÁßòÂØÜ„Å†„Å≠‚ú®', '„Éâ„Ç≠„Éâ„Ç≠„Åó„Å°„ÇÉ„ÅÜ„Å≠ÔºÅ'],
            '„Åä„Å™„Åã„Å∏„Å£„Åü': ['„Åê„ÅÖÔΩû„Å£„Å¶„Åä„Å™„Åã„Å™„Å£„Å°„ÇÉ„ÅÜ„Å≠üçö', '„Å™„Å´„Åã„Å§„Åè„ÇãÔºÅÔºü', '„Åî„ÅØ„Çì„ÅÆ„Åò„Åã„Çì„Å†„ÉºÔºÅ']
        };

        function sendChat() {
            const text = userInput.value.trim();
            if (!text) return;

            // Close menu via history back if open
            if (history.state && history.state.ui === 'menu') {
                history.back();
                // Note: back() is async. The Menu UI will close via popstate.
                // We proceed to process chat.
            } else {
                topicMenu.style.display = 'none';
            }
            userInput.value = '';

            showBubble('...');

            setTimeout(() => {
                // Affirmative responses for anything the user says
                const affirmativeBase = [
                    "„ÅÜ„Çì„ÅÜ„Çì„ÄÅ„Åù„ÅÜ„Å†„Å≠‚ú®",
                    "„ÇÇ„Åæ„ÅØ„ÅÑ„Å§„Åß„ÇÇ„ÅÇ„Å™„Åü„ÅÆÂë≥Êñπ„Å†„Çàüíï",
                    "„ÅÑ„ÅÑ„Çì„Å†„Çà„ÄÅ„Åù„ÅÆ„Åæ„Åæ„ÅßÂ§ß‰∏àÂ§´„ÇÇ„Åæ„ÄÇ",
                    "„Åå„Çì„Å∞„Å£„Å¶„Çã„Å≠„ÄÅ„Åà„Çâ„ÅÑ„Åà„Çâ„ÅÑ„ÇÇ„ÅæÔºÅüíÆ",
                    "„ÇÜ„Å£„Åè„Çä‰ºë„Çì„Åß„ÅÑ„ÅÑ„Çì„Å†„Çàüí§",
                    "„ÇÇ„Åæ„Å®„ÅÑ„Å£„Åó„Çá„Å´„ÄÅ„ÅÆ„Çì„Å≥„Çä„Åó„ÇàÔºü‚ú®"
                ];

                if (currentTopic === 'Â§¢Âç†„ÅÑ„Åó„Å¶üåô') {
                    showBubble(analyzeDream(text));
                } else {
                    const contextOptions = topicContexts[currentTopic] || affirmativeBase;
                    const response = contextOptions[Math.floor(Math.random() * contextOptions.length)];
                    showBubble(response);
                }

                if (Math.random() < 0.4) {
                    moma.classList.add('animate-bounce');
                    setTimeout(() => moma.classList.remove('animate-bounce'), 1000);
                }
            }, 800);
        }

        function analyzeDream(input) {
            let matches = [];
            for (let symbol in dreamDictionary) {
                if (input.includes(symbol)) {
                    matches.push(dreamDictionary[symbol]);
                }
            }

            if (matches.length > 0) {
                const intro = "„ÇÇ„Åæ„Å°„ÇÉ„Çì„ÅÆÂ§¢Âç†„ÅÑÁµêÊûú„ÇÇ„ÅæÔºÅ‚ú®\n";
                // If many matches, just pick some or join. Increased to 5.
                const result = matches.slice(0, 5).join('\n');
                return intro + result;
            } else {
                return "„Åµ„ÇÄ„Åµ„ÇÄ...‰∏çÊÄùË≠∞„Å™Â§¢„ÇÇ„Åæ„Å≠„Åá„ÄÇ„Åù„Çå„ÅØ„ÅÇ„Å™„Åü„ÅÆÂøÉ„ÅåÊñ∞„Åó„ÅÑ‰∏ñÁïå„ÇíÊ±Ç„ÇÅ„Å¶„ÅÑ„Çã„Çµ„Ç§„É≥„Åã„ÇÇ„ÅæÔºÅ‚ú®";
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                sendChat();
            }
        }

        let bubbleTimer = null;
        function showBubble(text) {
            if (bubbleTimer) clearTimeout(bubbleTimer);

            // Occasionally add name to bubble if registered
            let displayText = text;
            if (userNickname) {
                // Replace '„ÅÇ„Å™„Åü' with nickname
                displayText = text.replace(/„ÅÇ„Å™„Åü/g, userNickname);

                // Add name to short or specific texts
                if (Math.random() < 0.3 && !displayText.includes(userNickname) && displayText.length < 20 && displayText !== '...') {
                    const patterns = [
                        `${userNickname}„ÄÅ${displayText}`,
                        `${displayText}„ÄÅ${userNickname}ÔºÅ`,
                        `${userNickname}ÔºÅ${displayText}`
                    ];
                    displayText = patterns[Math.floor(Math.random() * patterns.length)];
                }
            }

            momaBubble.innerText = displayText;
            momaBubble.style.display = 'block';

            // Position bubble above Moma
            updateBubblePosition();

            // Hide after a while (dynamic duration based on text length)
            const duration = Math.max(5000, 3000 + displayText.length * 100);
            bubbleTimer = setTimeout(() => {
                momaBubble.style.display = 'none';
                bubbleTimer = null;
            }, duration);
        }

        function updateBubblePosition() {
            if (momaBubble.style.display === 'block') {
                const bubbleX = (momaX + 125 - momaBubble.offsetWidth / 2);
                const bubbleY = (momaY - momaBubble.offsetHeight - 20);

                // Clamp within screen horizontal
                const padding = 10;
                const clampedX = Math.max(padding, Math.min(bubbleX, window.innerWidth - momaBubble.offsetWidth - padding));

                // If character is too high, show bubble below instead
                let finalY = bubbleY;
                momaBubble.classList.remove('bubble-below');
                if (bubbleY < 10) {
                    finalY = momaY + moma.offsetHeight + 10;
                    momaBubble.classList.add('bubble-below');
                }

                momaBubble.style.left = clampedX + 'px';
                momaBubble.style.top = finalY + 'px';
            }
        }

        // Update bubble on move
        const originalUpdatePosition = updatePosition;
        updatePosition = function () {
            originalUpdatePosition();
            updateBubblePosition();
        };

        function createHeart(x, y, char = "‚ù§Ô∏è") {
            const heart = document.createElement('div');
            heart.classList.add('heart-bubble');
            heart.innerText = char;
            heart.style.left = x + 'px';
            heart.style.top = y + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1500);
        }

        // Handle Window Resize
        window.addEventListener('load', () => {
            width = container.offsetWidth;
            height = container.offsetHeight;
            updatePosition();
            loadMomaData();
            loadBirthdate();
        });
        window.addEventListener('resize', () => {
            width = container.offsetWidth;
            height = container.offsetHeight;
            updatePosition(); // Immediately clamp to new window size
        });
    </script>
</body>

</html>